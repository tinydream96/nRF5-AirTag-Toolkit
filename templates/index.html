<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nRF5 AirTag Toolkit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <!-- DAP.js for CMSIS-DAP/DAPLink WebUSB -->
    <script src="https://unpkg.com/dapjs/dist/dap.browser.min.js"></script>
    <style>
        :root {
            /* Apple Color Palette */
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-elevated: rgba(44, 44, 46, 0.8);

            --text-primary: #f5f5f7;
            --text-secondary: #d1d1d6;
            --text-tertiary: #b1b1b6;

            --accent-blue: #0a84ff;
            --accent-green: #30d158;
            --accent-red: #ff453a;
            --accent-orange: #ff9f0a;
            --accent-purple: #bf5af2;

            --border-color: rgba(255, 255, 255, 0.08);
            --border-focused: rgba(255, 255, 255, 0.18);

            /* Spacing */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 22px;

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }

        .app-header {
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            z-index: 100;
        }

        .app-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
        }

        .hero-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-y: auto;
        }

        .console-section {
            flex: 0 0 250px;
            min-height: 200px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-shrink: 0;
        }

        /* History Panel */
        .history-panel {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* Section Headers */
        .section-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
            padding: 0 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-header svg {
            opacity: 0.6;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 16px;
            padding-bottom: 0px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Input Styles */
        .input-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .input-field {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-focused);
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
        }

        /* Mode Toggle (Segmented Control) */
        .mode-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 3px;
            background: rgba(118, 118, 128, 0.24);
            border-radius: 9px;
            margin-bottom: 20px;
        }

        .mode-toggle button {
            border: none;
            background: none;
            padding: 6px 0;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-toggle button.active {
            background: #636366;
            color: white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
            font-weight: 600;
        }

        /* Improved Chip Grid */
        .chip-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .chip-btn {
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            /* No border by default */
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chip-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        .chip-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 6px rgba(10, 132, 255, 0.3);
            font-weight: 600;
            border-color: transparent;
        }

        .info-box {
            margin-top: 8px;
            margin-bottom: 20px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .info-box b {
            color: var(--text-primary);
        }

        /* Segmented Control */
        .segmented-control {
            display: flex;
            background: rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            padding: 3px;
            position: relative;
        }

        .segment-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        }

        .segment-btn.active {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.12);
        }

        /* Chip Selector */
        /* This section is replaced by Improved Chip Grid above */

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            cursor: pointer;
        }

        .toggle-row:hover .toggle-label {
            color: var(--text-primary);
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.15s ease;
        }

        .toggle-switch {
            width: 51px;
            height: 31px;
            background: var(--bg-tertiary);
            border-radius: 31px;
            position: relative;
            transition: background 0.25s ease;
            flex-shrink: 0;
        }

        .toggle-switch.on {
            background: var(--accent-green);
        }

        .toggle-knob {
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.on .toggle-knob {
            transform: translateX(20px);
        }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            height: 50px;
            background: var(--accent-blue);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary.danger {
            background: var(--accent-red);
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 16px;
            height: 16px;
            color: white;
        }

        .logo-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-text span {
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .lang-switcher {
            display: flex;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            padding: 2px;
        }

        .lang-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 11px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border-radius: 18px;
            transition: all 0.2s ease;
        }

        .lang-btn.active {
            background: white;
            color: black;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 20px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }

        .status-dot.ready {
            background: var(--text-tertiary);
        }

        .status-dot.busy {
            background: var(--accent-blue);
            animation: pulse 1.5s infinite;
        }

        .status-dot.success {
            background: var(--accent-green);
        }

        .status-dot.error {
            background: var(--accent-red);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .status-text {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Hero - glow effect disabled */
        .hero-glow {
            display: none;
        }

        .hero-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
        }

        .hero-device {
            font-size: 80px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -3px;
            line-height: 1;
            margin-bottom: 24px;
        }

        .hero-badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .hero-badge {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .badge-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .badge-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .badge-value.green {
            color: var(--accent-green);
        }

        .badge-value.muted {
            color: var(--text-tertiary);
        }

        /* Step Progress Indicator */
        .step-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin: 16px auto;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            max-width: 700px;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 72px;
        }

        .step-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            transition: all 0.3s ease;
        }

        .step-item.active .step-icon {
            background: rgba(10, 132, 255, 0.15);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .step-item.completed .step-icon {
            background: rgba(48, 209, 88, 0.15);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .step-item.error .step-icon {
            background: rgba(255, 69, 58, 0.15);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .step-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .step-item.active .step-label {
            color: var(--accent-blue);
        }

        .step-item.completed .step-label {
            color: var(--accent-green);
        }

        .step-item.error .step-label {
            color: var(--accent-red);
        }

        .step-sublabel {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            opacity: 0.8;
            margin-top: -4px;
            white-space: nowrap;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            min-width: 24px;
            max-width: 60px;
            margin: 0 4px;
            margin-bottom: 24px;
            transition: background 0.3s ease;
        }

        .step-line.active {
            background: var(--accent-green);
        }

        /* Status Box */
        .status-box {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin: 24px auto;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            max-width: 500px;
            text-align: left;
        }

        .status-box.info {
            border-color: rgba(10, 132, 255, 0.3);
            background: rgba(10, 132, 255, 0.08);
        }

        .status-box.info .status-box-icon {
            color: var(--accent-blue);
        }

        .status-box.waiting {
            border-color: rgba(255, 159, 10, 0.3);
            background: rgba(255, 159, 10, 0.08);
        }

        .status-box.waiting .status-box-icon {
            color: var(--accent-orange);
        }

        .status-box.working {
            border-color: rgba(10, 132, 255, 0.3);
            background: rgba(10, 132, 255, 0.08);
        }

        .status-box.working .status-box-icon {
            color: var(--accent-blue);
        }

        .status-box.success {
            border-color: rgba(48, 209, 88, 0.3);
            background: rgba(48, 209, 88, 0.08);
        }

        .status-box.success .status-box-icon {
            color: var(--accent-green);
        }

        .status-box.error {
            border-color: rgba(255, 69, 58, 0.3);
            background: rgba(255, 69, 58, 0.08);
        }

        .status-box.error .status-box-icon {
            color: var(--accent-red);
        }

        .status-box-icon {
            flex-shrink: 0;
        }

        .status-box-content {
            flex: 1;
        }

        .status-box-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .status-box-hint {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .reset-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .status-box.error .reset-btn {
            background: rgba(255, 69, 58, 0.2);
            border-color: rgba(255, 69, 58, 0.4);
            color: var(--accent-red);
        }

        .status-box.error .reset-btn:hover {
            background: rgba(255, 69, 58, 0.3);
        }

        /* Animations */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Console */
        .console-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .console-header {
            height: 40px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .console-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .console-btn {
            padding: 4px 10px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 11px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .console-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .console-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-line {
            display: flex;
            gap: 12px;
        }

        .log-time {
            color: var(--text-tertiary);
            opacity: 0.6;
            flex-shrink: 0;
            width: 56px;
        }

        .log-msg {
            color: var(--text-secondary);
        }

        .log-msg.success {
            color: var(--accent-green);
            font-weight: 600;
        }

        .log-msg.error {
            color: var(--accent-red);
            font-weight: 600;
        }

        .log-msg.accent {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .log-msg.warning {
            color: var(--accent-orange);
        }

        /* History Panel - Collapsible */
        .history-panel {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-panel.open {
            width: 300px;
        }

        .history-panel.closed {
            width: 48px;
        }

        .history-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .history-toggle:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
        }

        .history-badge-mini {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--accent-blue);
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-header {
            height: 48px;
            padding: 0 16px;
            padding-left: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .history-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .history-count {
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .history-toolbar {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
        }

        .toolbar-selected {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
        }

        .toolbar-icon-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .toolbar-icon-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
        }

        .toolbar-icon-btn.danger:hover {
            background: rgba(255, 69, 58, 0.15);
            color: var(--accent-red);
            border-color: rgba(255, 69, 58, 0.3);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .history-empty {
            padding: 48px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 13px;
        }

        .history-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .history-item.selected {
            background: rgba(10, 132, 255, 0.1);
            border-color: rgba(10, 132, 255, 0.3);
        }

        .history-item-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .history-item.selected .history-item-icon {
            background: rgba(10, 132, 255, 0.2);
            color: var(--accent-blue);
        }

        .history-item-info {
            flex: 1;
            min-width: 0;
        }

        .history-item-name {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, monospace;
            margin-bottom: 2px;
        }

        .history-item-time {
            display: block;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .history-item-check {
            width: 24px;
            height: 24px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .checkbox-hidden {
            display: none;
        }

        .history-table {
            width: 100%;
        }

        .history-table th {
            padding: 10px 16px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
            background: rgba(255, 255, 255, 0.02);
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: 10px 16px;
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .history-name {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-primary);
        }

        .history-time {
            color: var(--text-tertiary);
            font-size: 11px;
            text-align: right;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            appearance: none;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .checkbox:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .checkbox:checked::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 6px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Overlay Modal */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(40px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
        }

        .overlay-icon {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            border-width: 3px;
            border-style: solid;
        }

        .overlay-icon.success {
            border-color: var(--accent-green);
            box-shadow: 0 0 60px rgba(48, 209, 88, 0.4);
        }

        .overlay-icon.waiting {
            border-color: var(--accent-blue);
            box-shadow: 0 0 60px rgba(10, 132, 255, 0.4);
        }

        .overlay-icon.error {
            border-color: var(--accent-red);
            box-shadow: 0 0 60px rgba(255, 69, 58, 0.4);
        }

        .overlay-icon svg {
            width: 48px;
            height: 48px;
        }

        .overlay-title {
            font-size: 48px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 16px;
        }

        .overlay-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .overlay-download {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .overlay-download:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-green);
        }

        .download-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-green);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .download-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .download-text {
            text-align: left;
        }

        .download-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .download-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .overlay-dismiss {
            margin-top: 32px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Delete Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-card {
            width: 340px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 69, 58, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .modal-icon svg {
            width: 24px;
            height: 24px;
            color: var(--accent-red);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .modal-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .modal-btn {
            height: 44px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-primary);
        }

        .modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-btn.delete {
            background: var(--accent-red);
            color: white;
        }

        .modal-btn.delete:hover {
            filter: brightness(1.1);
        }

        /* Select Dropdown */
        .select-field {
            width: 100%;
            height: 44px;
            padding: 0 14px;
            padding-right: 40px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236e6e73'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
        }

        .select-field:focus {
            outline: none;
            border-color: var(--border-focused);
        }

        .select-field option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Spinning animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Mode description */
        .mode-desc {
            font-size: 12px;
            color: var(--text-tertiary);
            line-height: 1.5;
            padding: 8px 4px;
        }
    </style>
</head>

<body x-data="appData()" x-init="init()" x-cloak>

    <!-- Status Overlay -->
    <div x-show="lastNotification" @click="lastNotification = null" class="overlay"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" style="display: none;">

        <div class="overlay-icon" :class="{
                 'success': lastNotification && lastNotification.includes('SUCCESS'),
                 'waiting': lastNotification && (lastNotification.includes('WAITING') || lastNotification.includes('CONNECTED')),
                 'error': lastNotification && lastNotification.includes('ERROR')
             }">
            <template x-if="lastNotification && lastNotification.includes('SUCCESS')">
                <svg fill="none" stroke="currentColor" style="color: var(--accent-green)" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                </svg>
            </template>
            <template x-if="lastNotification && lastNotification.includes('WAITING')">
                <svg fill="none" stroke="currentColor"
                    style="color: var(--accent-blue); animation: pulse 1.5s infinite;" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </template>
            <template x-if="lastNotification && lastNotification.includes('CONNECTED')">
                <svg fill="none" stroke="currentColor" style="color: var(--accent-blue)" class="animate-spin"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </template>
            <template x-if="lastNotification && lastNotification.includes('ERROR')">
                <svg fill="none" stroke="currentColor" style="color: var(--accent-red)" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </template>
        </div>

        <h1 class="overlay-title"
            x-text="lastNotification ? lastNotification.replace('SUCCESS: ', '').replace('ERROR: ', '').replace('WAITING_CONNECTION: ', '').replace('DEVICE_CONNECTED: ', '') : ''">
        </h1>

        <p class="overlay-subtitle" x-show="lastNotification && lastNotification.includes('WAITING')">
            Connect your device via J-Link or ST-Link
        </p>

        <template x-if="downloadUrl && lastNotification && lastNotification.includes('SUCCESS')">
            <a :href="downloadUrl" @click.stop class="overlay-download">
                <div class="download-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </div>
                <div class="download-text">
                    <div class="download-label">Ready</div>
                    <div class="download-title" x-text="t('downloadZip')">Download Package</div>
                </div>
            </a>
        </template>

        <div class="overlay-dismiss" x-text="t('status_ready')">DISMISS</div>
    </div>

    <!-- Delete Modal -->
    <div x-show="deleteModal" class="modal-backdrop" x-transition.opacity style="display: none;">
        <div class="modal-card" @click.away="deleteModal = false">
            <div class="modal-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </div>
            <h3 class="modal-title" x-text="t('confirmDeleteTitle')">Delete Files?</h3>
            <p class="modal-desc" x-text="t('confirmDeleteDesc', {n: selectedFiles.length})"></p>
            <div class="modal-actions">
                <button class="modal-btn cancel" @click="deleteModal = false">Cancel</button>
                <button class="modal-btn delete" @click="executeDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div class="logo-text">nRF5 AirTag <span x-text="t('toolkit')">Toolkit</span></div>
            </div>

            <div class="header-controls">
                <div class="lang-switcher">
                    <button class="lang-btn" :class="lang === 'en' ? 'active' : ''" @click="lang = 'en'">EN</button>
                    <button class="lang-btn" :class="lang === 'zh' ? 'active' : ''" @click="lang = 'zh'">中文</button>
                </div>
                <div class="status-badge">
                    <div class="status-dot" :class="status.toLowerCase()"></div>
                    <span class="status-text" x-text="t('status_'+status.toLowerCase())"></span>
                </div>
            </div>
        </header>

        <!-- Main -->
        <div class="app-main">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-content">
                    <!-- Hardware & Sensing (Combined Top Group) -->
                    <div class="form-group">
                        <div class="section-header">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="13" height="13">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <span x-text="lang === 'zh' ? '运行模式' : 'WORK MODE'">运行模式</span>
                        </div>

                        <div class="mode-toggle">
                            <button :class="{'active': workMode === 'local'}" @click="workMode = 'local'">
                                <span x-text="lang === 'zh' ? '本地刷机' : 'Local Machine'"></span>
                            </button>
                            <button :class="{'active': workMode === 'cloud'}" @click="workMode = 'cloud'">
                                <span x-text="lang === 'zh' ? '云端/WebUSB' : 'Cloud/WebUSB'"></span>
                            </button>
                        </div>

                        <!-- Mode Description -->
                        <div class="info-box">
                            <div x-show="workMode === 'local'">
                                <span x-show="lang === 'zh'">
                                    ℹ️ <b>本地模式</b>：需下载本项目并在本地运行 Python 服务。调试器连接至<b>运行服务的电脑</b>。
                                </span>
                                <span x-show="lang === 'en'">
                                    ℹ️ <b>Local Mode</b>: Requires running this project locally. Debugger connects to
                                    the <b>backend server</b>.
                                </span>
                            </div>
                            <div x-show="workMode === 'cloud'">
                                <span x-show="lang === 'zh'">
                                    ℹ️ <b>WebUSB 模式</b>：纯浏览器操作，无需本地 Python 环境。调试器连接至<b>当前浏览器设备</b>。
                                </span>
                                <span x-show="lang === 'en'">
                                    ℹ️ <b>WebUSB Mode</b>: Browser-only. Debugger connects to <b>this device</b> via
                                    WebUSB.
                                </span>
                            </div>
                        </div>

                        <div class="section-header" x-show="workMode === 'local'">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="13" height="13">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                            </svg>
                            <span x-text="lang === 'zh' ? '本地硬件' : 'LOCAL HARDWARE'">本地硬件</span>
                        </div>

                        <!-- 1. LOCAL MODE HARDWARE -->
                        <div x-show="workMode === 'local'">
                            <label class="input-label" style="margin-bottom:6px; display:block;"
                                x-text="lang === 'zh' ? '本地调试器接口' : 'Local Interface'"></label>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                <select class="select-field" x-model="config.debugger" style="flex: 1; height: 38px;">
                                    <option value="1" x-text="getDebugOptionText('1', 'Segger J-Link (Native)')">
                                    </option>
                                    <option value="2" x-text="getDebugOptionText('2', 'ST-Link V2/V3 (OpenOCD)')">
                                    </option>
                                    <option value="3" x-text="getDebugOptionText('3', 'DAPLink (CMSIS-DAP)')"></option>

                                </select>
                            </div>
                        </div>

                        <!-- 2. CLOUD MODE HARDWARE (WebUSB) -->
                        <div x-show="workMode === 'cloud'">
                            <!-- ST-Link removed as per user request -->
                            <input type="hidden" x-model="webUsbDriver">

                            <div class="section-header" style="margin-top:15px; margin-bottom:10px;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="13" height="13">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <span x-text="lang === 'zh' ? '连接设备' : 'CONNECT DEVICE'"></span>
                            </div>

                            <button class="btn-primary" @click="connectWebUSB()" :disabled="isWebUsbConnecting"
                                :style="webUsbDevice ? 'background: rgba(48,209,88,0.15); color: var(--accent-green); border: 1px solid var(--accent-green);' : ''">
                                <span x-show="!isWebUsbConnecting && !webUsbDevice"
                                    x-text="lang === 'zh' ? '请求 USB 权限' : 'Request Permission'"></span>
                                <span x-show="isWebUsbConnecting"
                                    x-text="lang === 'zh' ? '正在连接...' : 'Connecting...'"></span>
                                <span x-show="webUsbDevice"
                                    x-text="webUsbDevice ? webUsbDevice.productName : ''"></span>
                            </button>
                        </div>

                        <!-- Intelligent Sensing Card (Local Mode Only) -->
                        <div x-show="workMode === 'local' && detectedChip"
                            style="display: flex; flex-direction: column; gap: 5px; padding: 10px 12px; background: rgba(48,209,88,0.1); border: 1px solid rgba(48,209,88,0.2); border-radius: 10px; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span
                                    style="color: var(--accent-green); font-weight: 700; font-size: 15px; font-family: 'Inter', system-ui;"
                                    x-text="detectedChip"></span>
                                <span
                                    style="color: var(--accent-green); font-size: 10px; font-weight: 600; opacity: 0.8;"
                                    x-text="lang === 'zh' ? '自动匹配 ✓' : 'Auto Matched ✓'"></span>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 10px; opacity: 0.8;"
                                x-text="lang === 'zh' ? '架构深度对齐，固件匹配率 100%' : 'Architecture deeply aligned, 100% match'">
                            </div>
                        </div>

                        <!-- Manual selection fallback (Shown if no chip detected OR in Cloud Mode) -->
                        <div x-show="workMode === 'cloud' || !detectedChip">
                            <label class="input-label" style="display:block; margin-bottom:6px;"
                                x-show="workMode === 'cloud'" x-text="lang === 'zh' ? '选择目标芯片' : 'Target Chip'"></label>
                            <div class="chip-grid" style="margin-bottom: 8px;">
                                <button class="chip-btn" :class="config.chip === '1' ? 'active' : ''"
                                    @click="config.chip = '1'">51822</button>
                                <button class="chip-btn" :class="config.chip === '2' ? 'active' : ''"
                                    @click="config.chip = '2'">52832</button>
                                <button class="chip-btn" :class="config.chip === '3' ? 'active' : ''"
                                    @click="config.chip = '3'">5281x</button>
                            </div>
                            <div style="font-size: 10px; color: var(--text-tertiary); opacity: 0.8; padding-left: 2px;"
                                x-show="workMode === 'local'"
                                x-text="lang === 'zh' ? '自动感知优先；受保护芯片请手动选择。' : 'Auto-sensing priority. Manual for protected.'">
                            </div>
                        </div>

                        <!-- Auto Flash Integrated Toggle -->
                        <div class="toggle-row" @click="config.autoflash = !config.autoflash"
                            style="margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05);">
                            <span class="toggle-label" style="font-size: 11px; font-weight: 500;"
                                x-text="t('autoflashTitle')">Auto Flash</span>
                            <div class="toggle-switch" :class="config.autoflash ? 'on' : ''"
                                style="transform: scale(0.9); transform-origin: right;">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Device Identity -->
                    <div class="form-group">
                        <div class="section-header">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="13" height="13">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                            </svg>
                            <span x-text="t('deviceIdentity')">DEVICE IDENTITY</span>
                        </div>
                        <div class="form-row">
                            <div>
                                <label class="input-label" x-text="t('prefix')">Prefix</label>
                                <input type="text" class="input-field" x-model="config.prefix"
                                    @input="$el.value = $el.value.toUpperCase().slice(0,5); config.prefix = $el.value"
                                    style="text-transform: uppercase; letter-spacing: 2px;">
                            </div>
                            <div>
                                <label class="input-label" x-text="t('index')">Index</label>
                                <input type="number" class="input-field" x-model="config.start_num">
                            </div>
                        </div>
                    </div>

                    <!-- Key Mode -->
                    <div class="form-group">
                        <div class="section-header">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="13" height="13">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            <span x-text="t('security')">KEY MODE</span>
                        </div>
                        <div class="segmented-control">
                            <button class="segment-btn" :class="config.mode === '1' ? 'active' : ''"
                                @click="config.mode = '1'" x-text="t('dynamicMode')">Dynamic</button>
                            <button class="segment-btn" :class="config.mode === '2' ? 'active' : ''"
                                @click="config.mode = '2'" x-text="t('staticMode')">Static</button>
                        </div>
                        <div class="mode-desc"
                            x-text="config.mode === '1' ? t('dynamicDesc') : t('staticDesc', {n: config.key_count})"
                            style="margin-top: 10px; font-size: 11px; opacity: 0.6;">
                        </div>
                        <template x-if="config.mode === '2'">
                            <div style="margin-top: 10px;">
                                <label class="input-label" x-text="t('keyCount')">Key Count</label>
                                <input type="number" class="input-field" x-model="config.key_count" min="1" max="200">
                            </div>
                        </template>
                    </div>

                    <!-- Timing -->
                    <div class="form-group">
                        <div class="section-header">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="13" height="13">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span x-text="t('timing')">TIMING</span>
                        </div>
                        <div class="form-row">
                            <div>
                                <label class="input-label" x-text="t('baseInterval')">Interval (ms)</label>
                                <input type="number" class="input-field" x-model="config.base_interval" step="10">
                            </div>
                            <div>
                                <label class="input-label" x-text="t('intervalStep')">Step (ms)</label>
                                <input type="number" class="input-field" x-model="config.interval_step" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="toggle-row" @click="config.flash_sd = !config.flash_sd" style="margin-top: 10px;">
                        <span class="toggle-label" x-text="t('flashSd') + ' (' + getStackName() + ')'">Flash
                            SoftDevice</span>
                        <div class="toggle-switch" :class="config.flash_sd ? 'on' : ''">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>

                    <div class="toggle-row" @click="config.dcdc = !config.dcdc">
                        <span class="toggle-label" x-text="t('enableDcdc')">Enable DC/DC</span>
                        <div class="toggle-switch" :class="config.dcdc ? 'on' : ''">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>

                </div>

                <div class="sidebar-footer">
                    <button class="btn-primary" :class="isFlashing ? 'danger' : ''"
                        @click="isFlashing ? cancelFlash() : startFlash()"
                        x-text="isFlashing ? t('cancel') : (workMode === 'local' ? t('startFlash') : (lang === 'zh' ? '云端生成固件' : 'Cloud Generate'))">
                        START FLASHING
                    </button>

                    <!-- WebUSB Write Button (Actual Implementation) -->
                    <button class="btn-primary flash-btn-remote"
                        style="margin-top: 10px; background: var(--accent-blue);"
                        x-show="workMode === 'cloud' && cloudHex && webUsbDevice" :disabled="isFlashing"
                        @click="flashWebUSB()" x-text="lang === 'zh' ? '写入硬件' : 'Write to Hardware'">
                        WRITE TO HARDWARE
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Hero -->
                <div class="hero-section">
                    <div class="hero-glow"
                        :class="status === 'Success' ? 'green' : (status === 'Error' ? 'red' : 'blue')">
                    </div>

                    <div style="position: relative; z-index: 1; text-align: center; width: 100%; max-width: 800px;">
                        <!-- Device Name -->
                        <div class="hero-title" x-text="t('heroTitle')">NEXT TARGET DEVICE</div>
                        <div class="hero-device" x-text="padDeviceName(config.prefix, config.start_num)">TEST001</div>

                        <!-- Step Progress Indicator -->
                        <div class="step-progress" x-show="isFlashing || currentStep > 0">
                            <div class="step-item" :class="getStepClass(1)">
                                <div class="step-icon">
                                    <svg x-show="currentStep < 1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                                    </svg>
                                    <svg x-show="currentStep === 1" class="animate-spin" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    <svg x-show="currentStep > 1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <div class="step-label" x-text="t('step_debugger')">调试器</div>
                                <div class="step-sublabel" x-show="debuggerName" x-text="debuggerName"></div>
                            </div>
                            <div class="step-line" :class="currentStep > 1 ? 'active' : ''"></div>
                            <div class="step-item" :class="getStepClass(2)">
                                <div class="step-icon">
                                    <svg x-show="currentStep < 2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                    </svg>
                                    <svg x-show="currentStep === 2" class="animate-spin" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    <svg x-show="currentStep > 2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <div class="step-label" x-text="t('step_chip')">芯片</div>
                                <div class="step-sublabel" x-show="detectedChip" x-text="detectedChip"></div>
                            </div>
                            <div class="step-line" :class="currentStep > 2 ? 'active' : ''"></div>
                            <div class="step-item" :class="getStepClass(3)">
                                <div class="step-icon">
                                    <svg x-show="currentStep < 3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                    </svg>
                                    <svg x-show="currentStep === 3" class="animate-spin" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    <svg x-show="currentStep > 3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <div class="step-label" x-text="t('step_build')">生成固件</div>
                            </div>
                            <div class="step-line" :class="currentStep > 3 ? 'active' : ''"></div>
                            <div class="step-item" :class="getStepClass(4)">
                                <div class="step-icon">
                                    <svg x-show="currentStep < 4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <svg x-show="currentStep === 4" class="animate-spin" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    <svg x-show="currentStep > 4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <div class="step-label" x-text="t('step_flash')">刷写</div>
                            </div>
                            <div class="step-line" :class="currentStep > 4 ? 'active' : ''"></div>
                            <div class="step-item" :class="getStepClass(5)">
                                <div class="step-icon">
                                    <svg x-show="currentStep < 5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <svg x-show="currentStep >= 5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        width="20" height="20">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <div class="step-label" x-text="t('step_done')">完成</div>
                            </div>
                        </div>

                    </div>

                    <!-- Auto-Correction Toast (Floating) -->
                    <div x-show="showAutoCorrectToast" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform translate-y-4"
                        x-transition:enter-end="opacity-100 transform translate-y-0"
                        x-transition:leave="transition ease-in duration-300"
                        x-transition:leave-start="opacity-100 transform translate-y-0"
                        x-transition:leave-end="opacity-0 transform translate-y-4"
                        style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none;">
                        <div
                            style="background: rgba(48,209,88,0.95); backdrop-filter: blur(10px); color: white; padding: 12px 24px; border-radius: 12px; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 32px rgba(48,209,88,0.3); border: 1px solid rgba(255,255,255,0.2);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            <span
                                x-text="lang === 'zh' ? '[智能校准] 型号差异已自动同步，不必担心。' : '[Smart Calibration] Chip auto-synced. No worries.'"></span>
                        </div>
                    </div>

                    <!-- Status Message Box -->
                    <div class="status-box" :class="statusBoxClass" x-show="currentStep > 0 || statusMessage">
                        <div class="status-box-icon">
                            <svg x-show="statusBoxClass === 'info'" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <svg x-show="statusBoxClass === 'waiting'" class="animate-pulse" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <svg x-show="statusBoxClass === 'working'" class="animate-spin" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <svg x-show="statusBoxClass === 'success'" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <svg x-show="statusBoxClass === 'error'" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </div>
                        <div class="status-box-content">
                            <div class="status-box-title" x-text="statusMessage">状态信息</div>
                            <div class="status-box-hint" x-text="statusHint" x-show="statusHint"></div>
                        </div>
                        <!-- Reset Button (show on error) -->
                        <button class="reset-btn" x-show="errorStep > 0 || (statusBoxClass === 'error' && !isFlashing)"
                            @click="resetState()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span x-text="lang === 'zh' ? '重试' : 'Retry'"></span>
                        </button>
                        <!-- Local Flash Button (Hybrid Mode) -->
                        <button class="reset-btn" style="margin-left:8px;"
                            x-show="(errorStep > 0 || (statusBoxClass === 'error' && !isFlashing)) && cloudHex"
                            @click="flashLocal()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 12h14M12 5l7 7-7 7" />
                            </svg>
                            <span x-text="lang === 'zh' ? '使用本地服务刷写' : 'Flash via Local Service'"></span>
                        </button>
                        <!-- Continue Next Device Button (show on success) -->
                        <button class="reset-btn" x-show="currentStep > 3 && !isFlashing"
                            style="background: rgba(94,92,230,0.15); color: #5E5CE6; border: 1px solid rgba(94,92,230,0.3); margin-left: auto;"
                            @click="startNextDevice()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span x-text="lang === 'zh' ? '继续下一个设备' : 'Next Device'"></span>
                        </button>
                    </div>

                    <!-- Offline Download Button (Prominent) -->
                    <div class="status-box"
                        style="margin-top: 10px; background: rgba(52, 199, 89, 0.1); border-color: rgba(52, 199, 89, 0.3);"
                        x-show="downloadUrl && !isFlashing && currentStep > 3">
                        <div class="status-box-icon" style="color: #34c759;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </div>
                        <div class="status-box-content">
                            <div class="status-box-title" style="color: #34c759;"
                                x-text="lang === 'zh' ? '离线刷机包已生成' : 'Offline Bundle Ready'"></div>
                            <div class="status-box-hint"
                                x-text="lang === 'zh' ? '如果没有反应，请下载此包并运行 flash_linux.sh' : 'If web flash fails, download this and run scripts.'">
                            </div>
                        </div>
                        <button class="reset-btn" style="background: #34c759; color: white;"
                            @click="window.location.href = downloadUrl">
                            <span x-text="lang === 'zh' ? '下载' : 'Download'"></span>
                        </button>
                    </div>

                    <!-- Parameter Badges (show when idle) -->
                    <div class="hero-badges" x-show="!isFlashing && currentStep === 0">
                        <div class="hero-badge">
                            <div class="badge-label" x-text="t('security')">Mode</div>
                            <div class="badge-value" x-text="config.mode === '1' ? t('dynamicMode') : t('staticMode')">
                                Dynamic</div>
                        </div>
                        <div class="hero-badge">
                            <div class="badge-label" x-text="t('baseInterval')">Interval</div>
                            <div class="badge-value"
                                x-text="(parseInt(config.base_interval) + (parseInt(config.start_num) * parseInt(config.interval_step))) + ' ms'">
                                2000 ms</div>
                        </div>
                        <div class="hero-badge">
                            <div class="badge-label" x-text="t('hardware')">Debugger</div>
                            <div class="badge-value"
                                x-text="config.debugger === '1' ? 'J-Link' : (config.debugger === '2' ? 'ST-Link' : 'DAPLink')">
                                ST-Link
                            </div>
                        </div>
                        <div class="hero-badge">
                            <div class="badge-label">Stack</div>
                            <div class="badge-value" :class="config.flash_sd ? 'green' : 'muted'"
                                x-text="config.flash_sd ? getStackName() : 'OFF'">S130</div>
                        </div>
                        <div class="hero-badge">
                            <div class="badge-label">DC/DC</div>
                            <div class="badge-value" :class="config.dcdc ? 'green' : 'muted'"
                                x-text="config.dcdc ? 'ON' : 'OFF'">OFF</div>
                        </div>
                    </div>
                </div>
                <!-- Console -->
                <div class="console-section">
                    <div class="console-panel">
                        <div class="console-header">
                            <span class="console-title" x-text="t('consoleTitle')">DIAGNOSTIC LOG</span>
                            <button class="console-btn" @click="clearLogs()" x-text="t('clear')">Clear</button>
                        </div>
                        <div class="console-body" id="log-scroll">
                            <template x-for="log in logs">
                                <div class="log-line">
                                    <span class="log-time" x-text="log.time"></span>
                                    <span class="log-msg" :class="getLogClass(log.class)" x-text="log.msg"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </main>

            <!-- History Panel (Collapsible) -->
            <aside class="history-panel" :class="historyOpen ? 'open' : 'closed'">
                <!-- Toggle Button (Always Visible) -->
                <button class="history-toggle" @click="historyOpen = !historyOpen"
                    :title="historyOpen ? 'Hide History' : 'Show History'">
                    <svg x-show="!historyOpen" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18"
                        height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <svg x-show="historyOpen" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18"
                        height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    <span class="history-badge-mini" x-show="!historyOpen && historyFiles.length > 0"
                        x-text="historyFiles.length"></span>
                </button>

                <!-- Panel Content -->
                <div class="history-content" x-show="historyOpen" x-transition:enter="slide-in"
                    x-transition:leave="slide-out">
                    <div class="history-header">
                        <div class="history-header-left">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"
                                style="opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="history-title" x-text="t('historyTitle')">History</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="history-count" x-text="historyFiles.length">0</span>
                            <button class="toolbar-icon-btn danger" x-show="historyFiles.length > 0"
                                @click="confirmClearAll()" title="Clear All History" style="padding: 4px;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="history-toolbar" x-show="selectedFiles.length > 0" x-transition>
                        <span class="toolbar-selected" x-text="selectedFiles.length + ' selected'"></span>
                        <div class="toolbar-actions">
                            <button class="toolbar-icon-btn" @click="downloadSelected()" title="Download">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </button>
                            <button class="toolbar-icon-btn danger" @click="confirmDelete()" title="Delete">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- List -->
                    <div class="history-list">
                        <template x-if="historyFiles.length === 0">
                            <div class="history-empty">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="32" height="32"
                                    style="opacity: 0.3; margin-bottom: 12px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span>尚无刷写记录</span>
                            </div>
                        </template>

                        <div class="history-items" x-show="historyFiles.length > 0">
                            <template x-for="file in historyFiles" :key="file.filename">
                                <div class="history-item"
                                    :class="selectedFiles.includes(file.filename) ? 'selected' : ''"
                                    @click="toggleFileSelect(file.filename)">
                                    <input type="checkbox" class="checkbox-hidden" :value="file.filename"
                                        x-model="selectedFiles">
                                    <div class="history-item-icon">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16"
                                            height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                        </svg>
                                    </div>
                                    <div class="history-item-info">
                                        <span class="history-item-name" x-text="file.name"></span>
                                        <span class="history-item-time" x-text="file.time"></span>
                                    </div>
                                    <div class="history-item-check" x-show="selectedFiles.includes(file.filename)">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16"
                                            height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        function appData() {
            return {
                lang: 'zh',
                config: {
                    prefix: 'TEST',
                    start_num: 1,
                    mode: '1',
                    key_count: 200,
                    debugger: '2',
                    chip: '1',
                    gen_offline: true,
                    flash_sd: true,
                    dcdc: false,
                    base_interval: 2000,
                    interval_step: 10,
                    autoflash: false
                },
                webUsbDriver: 'daplink',
                sessionId: (() => {
                    // Try to get existing sessionId from localStorage
                    let sid = localStorage.getItem('nrf5_session_id');
                    if (!sid) {
                        // Generate new sessionId if not found
                        sid = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                        localStorage.setItem('nrf5_session_id', sid);
                    }
                    return sid;
                })(),
                status: 'Ready',
                isFlashing: false,
                lastNotification: null,
                lastStatusStr: '',
                logs: [],
                downloadUrl: null,
                autoDetected: false,
                debuggerConnected: false,
                debuggerName: null,
                detectedChip: null,
                historyFiles: [],
                selectedFiles: [],
                deleteModal: false,
                historyOpen: false,
                workMode: 'local', // 'local' or 'cloud'
                cloudHex: null,
                webUsbDevice: null,
                webUsbProgress: 0,
                isWebUsbConnecting: false,
                currentStep: 0,
                errorStep: 0,
                statusMessage: '',
                statusHint: '',
                statusBoxClass: 'info',
                showAutoCorrectToast: false,
                i18n: {
                    en: {
                        toolkit: 'Toolkit',
                        deviceIdentity: 'Device Identity',
                        chipModel: 'Chip Model',
                        prefix: 'ID Prefix',
                        index: 'Start Number',
                        security: 'Key Mode',
                        dynamicMode: 'Dynamic',
                        staticMode: 'Static',
                        keyCount: 'Key Count (Max 200)',
                        dynamicDesc: 'Seeds generated infinitely in firmware. Keys rotate every 15 minutes.',
                        staticDesc: 'Cycles through a fixed set of {n} keys. Rotates every 15 minutes.',
                        timing: 'Timing',
                        baseInterval: 'Interval (ms)',
                        intervalStep: 'Step (ms)',
                        hardware: 'Debugger',
                        flashSd: 'Flash SoftDevice',
                        enableDcdc: 'Enable DC/DC',
                        startFlash: 'START FLASHING',
                        processing: 'FLASHING...',
                        heroTitle: 'NEXT TARGET DEVICE',
                        heroSubtitle: 'Broadcast set at {ms}ms.',
                        downloadZip: 'Download Package (.ZIP)',
                        consoleTitle: 'Diagnostic Log',
                        clear: 'Clear',
                        status_ready: 'Ready',
                        status_busy: 'Active',
                        status_success: 'Done',
                        status_error: 'Error',
                        auto: 'AUTO',
                        historyTitle: 'Flash History',
                        confirmDeleteTitle: 'Delete Files?',
                        confirmDeleteDesc: 'Are you sure you want to delete {n} files?',
                        autoflashTitle: 'Auto Flash',
                        autoflashDesc: 'Detect and flash immediately.',
                        cancel: 'CANCEL',
                        step_debugger: 'Debugger',
                        step_chip: 'Chip',
                        step_build: 'Build',
                        step_flash: 'Flash',
                        step_done: 'Done'
                    },
                    zh: {
                        toolkit: '工具包',
                        deviceIdentity: '设备标识',
                        chipModel: '芯片型号',
                        prefix: '识别前缀',
                        index: '起始编号',
                        security: '密钥模式',
                        dynamicMode: '动态生成',
                        staticMode: '固定循环',
                        keyCount: '密钥数量 (最大 200)',
                        dynamicDesc: '固件根据种子无限生成密钥，每 15 分钟轮换。',
                        staticDesc: '在固定的 {n} 个密钥中循环，每 15 分钟轮换。',
                        timing: '时序设置',
                        baseInterval: '广播间隔 (ms)',
                        intervalStep: '间隔增量 (ms)',
                        hardware: '调试器',
                        flashSd: '安装协议栈',
                        enableDcdc: '启用内部 DC/DC',
                        startFlash: '开始刷写',
                        processing: '正在刷写...',
                        heroTitle: '目标设备',
                        heroSubtitle: '广播间隔：{ms} 毫秒',
                        downloadZip: '下载密钥包 (.ZIP)',
                        consoleTitle: '诊断日志',
                        clear: '清除',
                        status_ready: '就绪',
                        status_busy: '执行中',
                        status_success: '完成',
                        status_error: '失败',
                        auto: '已识别',
                        historyTitle: '历史记录',
                        confirmDeleteTitle: '确认删除？',
                        confirmDeleteDesc: '确定要删除这 {n} 个文件吗？',
                        autoflashTitle: '等待连接',
                        autoflashDesc: '检测到芯片后自动刷入。',
                        cancel: '取消',
                        step_debugger: '调试器',
                        step_chip: '芯片检测',
                        step_build: '生成固件',
                        step_flash: '刷写',
                        step_done: '完成'
                    }
                },

                t(key, params = {}) {
                    let text = this.i18n[this.lang][key] || key;
                    for (let p in params) text = text.replace(`{${p}}`, params[p]);
                    return text;
                },

                getDebugOptionText(val, defaultLabel) {
                    // Check if this option matches ANY connected debugger
                    if (this.debuggerConnected) {
                        const available = this.availableDebuggers || [];
                        if (available.includes(val)) {
                            // If selected, show "Active". If just available, show "Ready".
                            if (this.config.debugger === val) return defaultLabel + (this.lang === 'zh' ? ' (✅ 使用中)' : ' (✅ Active)');
                            return defaultLabel + (this.lang === 'zh' ? ' (⚪️ 可用)' : ' (⚪️ Ready)');
                        }
                    }
                    return defaultLabel;
                },

                init() {
                    window.alpineApp = this;
                    setInterval(() => this.poll(), 800);
                    setInterval(() => this.detectHardware(), 2000);
                    this.fetchHistory();
                },

                async detectHardware() {
                    if (this.isFlashing) return;
                    try {
                        const res = await fetch('/api/detect_debugger');
                        const data = await res.json();
                        if (data.detected) {
                            // Smart Switch: 
                            // Only switch if current selection is NOT available, OR if we haven't auto-detected yet.
                            // This allows user to manually choose ST-Link even if DAPLink (Higher Priority) is also plugged in.
                            const available = data.available || [data.debugger];
                            const currentIsValid = available.includes(this.config.debugger);

                            if (!currentIsValid || !this.autoDetected) {
                                if (data.debugger && data.debugger !== this.config.debugger) {
                                    this.config.debugger = data.debugger;
                                    this.autoDetected = true;
                                }
                            }
                            this.debuggerConnected = true;

                            // Visuals: If multiple connected, update visual name logic if needed. 
                            // But keeping it simple: just show checked status.
                            this.debuggerName = data.name;

                            // Store available list for UI highlighting
                            this.availableDebuggers = available;
                        } else {
                            this.debuggerConnected = false;
                            this.debuggerName = null;
                            this.availableDebuggers = [];
                        }
                    } catch (e) {
                        this.debuggerConnected = false;
                        this.debuggerName = null;
                    }
                },

                padDeviceName(prefix, num) {
                    let p = (prefix || 'TEST').toUpperCase();
                    let padding = Math.max(1, 6 - p.length);
                    return p + num.toString().padStart(padding, '0');
                },

                getLogClass(cls) {
                    if (!cls) return '';
                    if (cls.includes('red')) return 'error';
                    if (cls.includes('green')) return 'success';
                    if (cls.includes('purple') || cls.includes('accent')) return 'accent';
                    if (cls.includes('yellow')) return 'warning';
                    return '';
                },

                getStackName() {
                    const map = { '1': 'S130', '2': 'S132', '3': 'S112' };
                    return map[this.config.chip] || 'S130';
                },

                resetState() {
                    this.currentStep = 0;
                    this.errorStep = 0;
                    this.statusMessage = '';
                    this.statusHint = '';
                    this.statusBoxClass = 'info';
                    this.isFlashing = false;
                    this.status = 'Ready';
                    this.downloadUrl = null;
                    this.lastNotification = null;
                    this.detectedChip = null;
                },

                getStepClass(stepNum) {
                    if (this.errorStep === stepNum) return 'error';
                    if (this.currentStep > stepNum) return 'completed';
                    if (this.currentStep === stepNum) return 'active';
                    return '';
                },

                updateStepFromStatus(status) {
                    const s = status.toLowerCase();
                    if (!s.includes('error')) this.errorStep = 0;

                    if (s.includes('checking debugger') || s.includes('debugger:') || s.startsWith('debugger')) {
                        this.currentStep = 1;
                        if (s.includes('j-link') || s.includes('jlink')) {
                            this.statusMessage = this.lang === 'zh' ? '调试器: Segger J-Link ✓' : 'Debugger: Segger J-Link ✓';
                        } else if (s.includes('st-link') || s.includes('stlink')) {
                            this.statusMessage = this.lang === 'zh' ? '调试器: ST-Link ✓' : 'Debugger: ST-Link ✓';
                        } else {
                            this.statusMessage = this.lang === 'zh' ? '正在检测调试器...' : 'Detecting debugger...';
                        }
                        this.statusHint = this.lang === 'zh' ? '请确保调试器已连接到电脑' : 'Make sure debugger is connected';
                        this.statusBoxClass = 'working';
                    }
                    else if (s.includes('checking chip') || s.includes('chip:') || s.startsWith('chip')) {
                        this.currentStep = 2;
                        if (s.includes('nrf51822')) {
                            this.detectedChip = 'nRF51822';
                            this.statusMessage = this.lang === 'zh' ? '芯片: nRF51822 ✓' : 'Chip: nRF51822 ✓';
                        } else if (s.includes('nrf52832')) {
                            this.detectedChip = 'nRF52832';
                            this.statusMessage = this.lang === 'zh' ? '芯片: nRF52832 ✓' : 'Chip: nRF52832 ✓';
                        } else if (s.includes('nrf52810')) {
                            this.detectedChip = 'nRF52810';
                            this.statusMessage = this.lang === 'zh' ? '芯片: nRF52810 ✓' : 'Chip: nRF52810 ✓';
                        } else if (s.includes('nrf52811')) {
                            this.detectedChip = 'nRF52811';
                            this.statusMessage = this.lang === 'zh' ? '芯片: nRF52811 ✓' : 'Chip: nRF52811 ✓';
                        } else {
                            this.statusMessage = this.lang === 'zh' ? '正在检测芯片...' : 'Detecting chip...';
                        }
                        this.statusHint = this.lang === 'zh' ? '请确保芯片已正确连接到调试器' : 'Make sure chip is connected to debugger';
                        this.statusBoxClass = 'working';
                    }
                    // Step 3: Build
                    else if (s.includes('generating') || s.includes('compiling') || s.includes('building') || s.includes('firmware') || s.includes('offline keys') || s.includes('seed')) {
                        this.currentStep = 3;
                        this.statusMessage = this.lang === 'zh' ? '正在生成固件...' : 'Building firmware...';
                        this.statusHint = this.lang === 'zh' ? '正在编译固件，请稍候' : 'Compiling firmware, please wait';
                        this.statusBoxClass = 'working';
                    }
                    // Step 4: Flash
                    else if (s.includes('flashing') || s.includes('writing') || s.includes('programming') || s.includes('patching')) {
                        this.currentStep = 4;
                        this.statusMessage = this.lang === 'zh' ? '正在刷写固件...' : 'Flashing firmware...';
                        this.statusHint = this.lang === 'zh' ? '请勿断开连接，刷写过程中请保持设备稳定' : 'Do not disconnect. Keep device stable during flash';
                        this.statusBoxClass = 'working';
                    }
                    // Step 5: Success
                    else if (s.includes('success') || s.includes('done') || s.includes('complete')) {
                        this.currentStep = 5;
                        this.statusMessage = this.lang === 'zh' ? '✓ 刷写完成！' : '✓ Flash complete!';
                        this.statusHint = this.lang === 'zh' ? '设备已成功烧录，可以断开连接' : 'Device programmed successfully. You can disconnect now';
                        this.statusBoxClass = 'success';
                    }
                    // Errors
                    else if (s.includes('error')) {
                        this.statusBoxClass = 'error';

                        // Debugger not found
                        if (s.includes('debugger not found') || s.includes('debugger missing')) {
                            this.errorStep = 1;
                            this.statusMessage = this.lang === 'zh' ? '✕ 调试器未检测到' : '✕ Debugger not detected';
                            this.statusHint = this.lang === 'zh' ? '请检查调试器的 USB 连接，并确认驱动已正确安装' : 'Check USB connection and ensure drivers are installed';
                        }
                        // Chip protected
                        else if (s.includes('protected') || s.includes('protection')) {
                            this.errorStep = 2;
                            this.statusMessage = this.lang === 'zh' ? '✕ 芯片已被保护' : '✕ Chip is protected';
                            this.statusHint = this.lang === 'zh' ? '芯片启用了读保护。需要执行 mass erase（完全擦除）后才能刷写' : 'Chip has read protection enabled. Run mass erase to unlock';
                        }
                        // Chip mismatch
                        else if (s.includes('mismatch') || s.includes('detected')) {
                            this.errorStep = 2;
                            // Extract detected chip from status message
                            const match = s.match(/detected\s+(nrf\d+)/i);
                            const detectedChip = match ? match[1].toUpperCase() : 'Unknown';
                            this.statusMessage = this.lang === 'zh' ? `✕ 芯片型号不匹配 (${detectedChip})` : `✕ Chip mismatch (${detectedChip})`;
                            this.statusHint = this.lang === 'zh' ? '检测到的芯片与设置不符。请在左侧「芯片型号」中选择正确的型号后重试' : 'Detected chip differs from selection. Update chip model in settings and retry';
                        }
                        // Chip disconnected
                        else if (s.includes('disconnected') || s.includes('not found') && s.includes('chip')) {
                            this.errorStep = 2;
                            this.statusMessage = this.lang === 'zh' ? '✕ 芯片未连接' : '✕ Chip not connected';
                            this.statusHint = this.lang === 'zh' ? '请检查芯片与调试器的连线（VCC/GND/SWDIO/SWCLK）' : 'Check chip wiring (VCC/GND/SWDIO/SWCLK)';
                        }
                        // Build error
                        else if (s.includes('compile') || s.includes('build') || s.includes('make')) {
                            this.errorStep = 3;
                            this.statusMessage = this.lang === 'zh' ? '✕ 固件编译失败' : '✕ Firmware build failed';
                            this.statusHint = this.lang === 'zh' ? '编译过程出错，请检查日志获取详细信息' : 'Build error. Check logs for details';
                        }
                        // Flash error
                        else if (s.includes('flash') || s.includes('write') || s.includes('program')) {
                            this.errorStep = 4;
                            this.statusMessage = this.lang === 'zh' ? '✕ 固件刷写失败' : '✕ Flash failed';
                            this.statusHint = this.lang === 'zh' ? '刷写过程出错，请检查连接并重试' : 'Flash error. Check connection and retry';
                        }
                        // Generic error
                        else {
                            this.errorStep = this.currentStep || 1;
                            this.statusMessage = this.lang === 'zh' ? '✕ 操作失败' : '✕ Operation failed';
                            this.statusHint = this.lang === 'zh' ? '请查看日志获取详细错误信息' : 'Check logs for error details';
                        }
                    }
                    // Waiting state
                    else if (s.includes('waiting') || s.includes('ready') || s.includes('idle') || s.includes('initializing')) {
                        if (this.isFlashing && this.currentStep === 0) {
                            this.currentStep = 1;
                        }
                        this.statusMessage = this.lang === 'zh' ? '正在初始化...' : 'Initializing...';
                        this.statusHint = this.lang === 'zh' ? '准备开始刷写流程' : 'Preparing flash process';
                        this.statusBoxClass = 'working';
                    }
                },

                async startFlash() {
                    if (this.workMode === 'cloud') {
                        return this.startCloudFlash();
                    }
                    this.lastNotification = null;
                    this.isFlashing = true;
                    this.status = 'Busy';
                    this.downloadUrl = null;
                    // Reset step progress
                    this.currentStep = 1;
                    this.errorStep = 0;
                    this.statusMessage = this.lang === 'zh' ? '正在初始化...' : 'Initializing...';
                    this.statusHint = this.lang === 'zh' ? '准备开始刷写流程' : 'Preparing flash process';
                    this.statusBoxClass = 'working';
                    try {
                        await fetch('/api/flash', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...this.config,
                                session_id: this.sessionId
                            })
                        });
                    } catch (e) {
                        this.isFlashing = false;
                        this.status = 'Error';
                        this.errorStep = 1;
                        this.statusMessage = this.lang === 'zh' ? '✕ 请求失败' : '✕ Request failed';
                        this.statusHint = e.message;
                        this.statusBoxClass = 'error';
                        this.addLog(e.message, 'error');
                    }
                },

                async startCloudFlash() {
                    this.addLog('[Cloud] Requesting firmware...', 'accent');
                    this.status = 'Busy';
                    this.isFlashing = true;
                    this.currentStep = 3; // Jump to Build step
                    this.statusMessage = this.lang === 'zh' ? '正在云端生成固件...' : 'Generating firmware in cloud...';

                    try {
                        const res = await fetch('/api/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...this.config,
                                session_id: this.sessionId // Pass isolation ID
                            })
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.cloudHex = data.hex;
                            if (data.bundle_url) {
                                this.downloadUrl = data.bundle_url;
                            }
                            this.addLog(`[Cloud] Firmware generated: ${data.device_name}`, 'success');
                            this.currentStep = 4; // Move to Flash step
                            this.statusMessage = this.lang === 'zh' ? '固件就绪，请选择刷写方式' : 'Firmware ready, choose flash method';
                            this.statusHint = this.lang === 'zh' ? '点击“写入硬件”通过 USB 刷写' : 'Click "Write to Hardware" to flash via USB';
                            this.statusBoxClass = 'waiting';

                            // For demo purposes, we log the first few lines of HEX
                            this.addLog(`[Cloud] HEX Data received (${data.hex.length} bytes)`, 'info');
                            this.isFlashing = false;

                            // Auto-refresh history to show newly generated device
                            this.fetchHistory();
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (e) {
                        this.isFlashing = false;
                        this.status = 'Error';
                        this.errorStep = 3;
                        this.statusMessage = this.lang === 'zh' ? '✕ 云端生成失败' : '✕ Cloud generation failed';
                        this.statusHint = e.message;
                        this.statusBoxClass = 'error';
                        this.addLog(e.message, 'error');
                    }
                },

                async connectWebUSB() {
                    // Safety check for WebUSB context
                    if (!navigator.usb) {
                        const errorMsg = this.lang === 'zh'
                            ? '当前浏览器环境不支持 WebUSB。请确保：\n1. 使用 Chrome/Edge 浏览器\n2. 使用 localhost 或 HTTPS 访问 (当前是非安全上下文)'
                            : 'WebUSB is not supported. Ensure:\n1. You are using Chrome/Edge\n2. You are using localhost or HTTPS (Current context is insecure)';
                        this.addLog(errorMsg, 'error');
                        alert(errorMsg);
                        return;
                    }

                    this.isWebUsbConnecting = true;
                    this.addLog('[WebUSB] Requesting device...', 'info');
                    try {
                        // Filters for common debuggers
                        const filters = [
                            { vendorId: 0x0d28 }, // DAPLink / CMSIS-DAP
                            { vendorId: 0x0483 }, // ST-Link (requires WinUSB on Windows)
                            { vendorId: 0x1366 }  // J-Link (experimental)
                        ];

                        this.webUsbDevice = await navigator.usb.requestDevice({ filters: filters });
                        this.addLog(`[WebUSB] Connected to ${this.webUsbDevice.productName}`, 'success');
                        this.statusMessage = this.lang === 'zh' ? `已连接: ${this.webUsbDevice.productName}` : `Connected: ${this.webUsbDevice.productName}`;
                        this.statusBoxClass = 'success';

                        // ST-Link WebUSB compatibility warning
                        if (this.webUsbDevice.vendorId === 0x0483) {
                            const warningMsg = this.lang === 'zh'
                                ? '⚠️ ST-Link 与 WebUSB 兼容性有限。建议使用"本地模式"刷写，或换用 CMSIS-DAP/DAPLink 调试器。'
                                : '⚠️ ST-Link has limited WebUSB compatibility. Use "Local Mode" or a CMSIS-DAP/DAPLink debugger.';
                            this.addLog(warningMsg, 'warning');
                        }
                    } catch (e) {
                        this.addLog(`[WebUSB] Connection failed: ${e.message}`, 'error');
                    } finally {
                        this.isWebUsbConnecting = false;
                    }
                },

                async flashWebUSB() {
                    if (!this.webUsbDevice || !this.cloudHex) return;

                    this.addLog('[WebUSB] Starting flash sequence...', 'accent');
                    this.isFlashing = true;
                    this.currentStep = 4;
                    this.webUsbProgress = 0;
                    this.statusMessage = this.lang === 'zh' ? '正在通过 WebUSB 刷写...' : 'Flashing via WebUSB...';

                    try {
                        // 1. Convert HEX to Binary
                        const binaryData = this.parseHex(this.cloudHex);
                        this.addLog(`[WebUSB] Binary prepared: ${binaryData.length} bytes`, 'info');

                        // 2. Determine driver
                        if (this.webUsbDriver === 'daplink') {
                            await this.flashWithDAP(binaryData);
                        } else {
                            await this.flashWithSTLink(binaryData);
                        }

                        this.addLog('[WebUSB] Flash successful!', 'success');
                        this.currentStep = 5;
                        this.statusMessage = this.lang === 'zh' ? '✓ WebUSB 刷写成功' : '✓ WebUSB Flash successful';
                    } catch (e) {
                        this.addLog(`[WebUSB] Flash failed: ${e.message}`, 'error');
                        this.errorStep = 4;
                        this.statusMessage = this.lang === 'zh' ? '✕ WebUSB 刷写失败' : '✕ WebUSB Flash failed';
                    } finally {
                        this.isFlashing = false;
                    }
                },

                async flashWithSTLink(data) {
                    this.addLog('[ST-Link] Initializing ST-Link...', 'info');
                    const stlink = new STLinkV2(this.webUsbDevice);
                    await stlink.connect();
                    this.addLog('[ST-Link] Entering SWD mode...', 'info');
                    await stlink.enterSWD();

                    const coreId = await stlink.readCoreId();
                    this.addLog(`[ST-Link] Target connected (CoreID: 0x${coreId.toString(16)})`, 'success');

                    // nRF5x Flash Sequence via NVMC
                    this.addLog('[ST-Link] Erasing and programming nRF5x...', 'info');

                    const NVMC_BASE = 0x4001E000;
                    const NVMC_CONFIG = NVMC_BASE + 0x504;
                    const NVMC_ERASEALL = NVMC_BASE + 0x50C;
                    const NVMC_READY = NVMC_BASE + 0x400;

                    // 1. Erase All
                    await stlink.writeMem32(NVMC_CONFIG, 2); // ERASE mode
                    await stlink.writeMem32(NVMC_ERASEALL, 1);
                    // Wait for ready
                    let ready = 0;
                    let timeout = 50;
                    while (!(ready & 1) && timeout-- > 0) {
                        ready = await stlink.readMem32(NVMC_READY);
                        await new Promise(r => setTimeout(r, 100));
                    }
                    this.addLog('[ST-Link] Chip erased.', 'success');

                    // 2. Program
                    await stlink.writeMem32(NVMC_CONFIG, 1); // WRITE mode
                    const flashBase = 0x00000000;
                    const chunkSize = 256;
                    for (let offset = 0; offset < data.length; offset += chunkSize) {
                        const chunk = data.slice(offset, offset + chunkSize);
                        await stlink.writeMem(flashBase + offset, chunk);
                        this.webUsbProgress = Math.round((offset / data.length) * 100);

                        if (offset % 2048 === 0) {
                            this.addLog(`[ST-Link] Progress: ${this.webUsbProgress}%`, 'info');
                        }
                    }

                    await stlink.writeMem32(NVMC_CONFIG, 0); // READ mode
                    await stlink.reset();
                    this.webUsbProgress = 100;
                },

                async flashWithDAP(data) {
                    this.addLog('[DAP] Initializing CMSIS-DAP...', 'info');
                    // DAPjs usage:
                    const transport = new DAPjs.WebUSB(this.webUsbDevice);
                    const target = new DAPjs.CortexM(transport);

                    await target.connect();
                    this.addLog('[DAP] Target connected. Erasing...', 'info');

                    const NVMC_BASE = 0x4001E000;
                    const NVMC_CONFIG = NVMC_BASE + 0x504;
                    const NVMC_ERASEALL = NVMC_BASE + 0x50C;
                    const NVMC_READY = NVMC_BASE + 0x400;

                    // 1. Erase All
                    await target.writeMem32(NVMC_CONFIG, 2); // ERASE mode
                    await target.writeMem32(NVMC_ERASEALL, 1);

                    // Wait for ready
                    let ready = 0;
                    while ((ready & 1) === 0) {
                        ready = await target.readMem32(NVMC_READY);
                        await new Promise(r => setTimeout(r, 50));
                    }
                    this.addLog('[DAP] Chip erased.', 'success');

                    // 2. Program
                    this.addLog('[DAP] Programming...', 'info');
                    await target.writeMem32(NVMC_CONFIG, 1); // WRITE mode

                    const flashBase = 0x00000000;
                    const chunkSize = 1024; // DAPLink can handle larger blocks

                    for (let offset = 0; offset < data.length; offset += chunkSize) {
                        const chunk = data.slice(offset, offset + chunkSize);
                        // DAPjs writeBlock equivalent (writeMem behaves like block write for arrays)
                        await target.writeBlock(flashBase + offset, chunk);

                        this.webUsbProgress = Math.round((offset / data.length) * 100);
                        if (offset % 4096 === 0) {
                            this.addLog(`[DAP] Progress: ${this.webUsbProgress}%`, 'info');
                        }
                    }

                    await target.writeMem32(NVMC_CONFIG, 0); // READ mode
                    this.addLog('[DAP] Resetting...', 'info');
                    await target.reset();
                    await target.disconnect();
                    this.webUsbProgress = 100;
                },

                parseHex(hexString) {
                    const lines = hexString.split('\n');
                    let binary = [];
                    for (let line of lines) {
                        if (!line.startsWith(':')) continue;
                        const len = parseInt(line.substr(1, 2), 16);
                        const type = parseInt(line.substr(7, 2), 16);
                        if (type === 0x00) { // Data record
                            const data = line.substr(9, len * 2);
                            for (let i = 0; i < data.length; i += 2) {
                                binary.push(parseInt(data.substr(i, 2), 16));
                            }
                        }
                    }
                    return new Uint8Array(binary);
                },

                async flashLocal() {
                    if (!this.cloudHex) return;
                    this.statusMessage = this.lang === 'zh' ? '正在提交到本地服务...' : 'Submitting to local service...';
                    this.isFlashing = true;

                    try {
                        const res = await fetch('http://127.0.0.1:5001/api/flash_hex', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                hex: this.cloudHex,
                                chip_name: this.chip,
                                debugger: this.config.debugger // Use config value instead of hardcoded '2'
                            })
                        });
                        const d = await res.json();
                        if (d.success) {
                            this.statusMessage = this.lang === 'zh' ? '本地服务处理中...' : 'Local service processing...';
                            this.addLog('Submitted to local flash service.', 'info');
                            // Polling will take over
                        } else {
                            this.statusMessage = 'Error: ' + d.error;
                            this.isFlashing = false;
                            this.addLog('Failed to submit: ' + d.error, 'error');
                        }
                    } catch (e) {
                        this.statusMessage = 'Error: ' + e;
                        this.isFlashing = false;
                    }
                },

                async cancelFlash() {
                    try {
                        await fetch('/api/flash/cancel', { method: 'POST' });
                        this.addLog('Cancelling...', 'warning');
                    } catch (e) { }
                },

                async poll() {
                    try {
                        const res = await fetch(`/api/logs?session_id=${this.sessionId}&start=${this.logs.length}`);
                        const data = await res.json();

                        if (data.logs.length > this.logs.length) {
                            const newLogs = data.logs.slice(this.logs.length);
                            this.logs = [...this.logs, ...newLogs];

                            // Scan new logs for hardware info and auto-correction events
                            newLogs.forEach(l => {
                                const msg = l.msg.toLowerCase();
                                // Extract Debugger Name (e.g., "Debugger: Segger J-Link ✓")
                                if (msg.includes('debugger:')) {
                                    const match = l.msg.match(/Debugger:\s+([^✓|]+)/i);
                                    if (match) this.debuggerName = match[1].trim();
                                }
                                // Extract Chip Model (e.g., "Chip: nRF51822 ✓")
                                if (msg.includes('chip:')) {
                                    const match = l.msg.match(/Chip:\s+([^✓|]+)/i);
                                    if (match) this.detectedChip = match[1].trim();
                                }
                                // Auto-correction
                                if (msg.includes('architecture mismatch') || msg.includes('架构偏移')) {
                                    this.showAutoCorrectToast = true;
                                    setTimeout(() => { this.showAutoCorrectToast = false; }, 4000);
                                }

                                // CRITICAL FIX: Update step progress based on LOG MESSAGES, not just status
                                if (this.isFlashing || data.is_flashing) {
                                    this.updateStepFromStatus(msg);
                                }
                            });

                            this.$nextTick(() => {
                                const el = document.getElementById('log-scroll');
                                if (el) el.scrollTop = el.scrollHeight;
                            });
                        }

                        // Also check status_message for completion states
                        const statusMsg = data.status_message || data.status || '';
                        if (statusMsg && statusMsg !== this.lastStatusStr) {
                            this.lastStatusStr = statusMsg;

                            // Update step progress based on backend status
                            if (this.isFlashing || data.is_flashing) {
                                this.updateStepFromStatus(statusMsg.toLowerCase());
                            }

                            if (statusMsg.startsWith('WAITING') ||
                                statusMsg.startsWith('DEVICE') ||
                                statusMsg.startsWith('SUCCESS') ||
                                statusMsg.startsWith('ERROR')) {
                                this.lastNotification = statusMsg;
                            }

                            if (statusMsg.startsWith('SUCCESS')) {
                                this.config.start_num = parseInt(this.config.start_num) + 1;
                                this.fetchHistory();
                                this.status = 'Success';
                            } else if (statusMsg === 'Error' || statusMsg.includes('Error')) {
                                this.status = 'Error';
                            } else if (data.is_flashing) {
                                this.status = 'Busy';
                            } else {
                                this.status = 'Ready';
                            }
                        }

                        // Reset step state when flashing completes
                        const wasFlashing = this.isFlashing;
                        this.isFlashing = data.is_flashing;


                        // Keep success UI visible until next flash starts
                        // (No auto-reset - user requested persistent download view)

                        // Use download_url from API response (session-specific)
                        if (data.download_url && !this.downloadUrl) {
                            this.downloadUrl = data.download_url;
                        }
                    } catch (e) {
                        console.error('Log fetch failed', e);
                    }
                },

                async clearLogs() {
                    try {
                        await fetch(`/api/logs/clear?session_id=${this.sessionId}`, { method: 'POST' });
                        this.logs = [];
                    } catch (e) {
                        console.error('Clear failed', e);
                    }
                },

                addLog(msg, cls) {
                    this.logs.push({
                        time: new Date().toLocaleTimeString('en-US', { hour12: false, minute: '2-digit', second: '2-digit' }),
                        msg: msg,
                        class: cls
                    });
                },

                async fetchHistory() {
                    try {
                        const res = await fetch(`/api/history?session_id=${this.sessionId}`);
                        const data = await res.json();
                        this.historyFiles = data.files;
                        const fileSet = new Set(this.historyFiles.map(f => f.filename));
                        this.selectedFiles = this.selectedFiles.filter(f => fileSet.has(f));
                    } catch (e) { }
                },

                toggleSelectAll(checked) {
                    this.selectedFiles = checked ? this.historyFiles.map(f => f.filename) : [];
                },

                toggleFileSelect(filename) {
                    const idx = this.selectedFiles.indexOf(filename);
                    if (idx > -1) {
                        this.selectedFiles.splice(idx, 1);
                    } else {
                        this.selectedFiles.push(filename);
                    }
                },

                async downloadSelected() {
                    if (this.selectedFiles.length === 0) return;

                    // If only one file selected, download directly
                    if (this.selectedFiles.length === 1) {
                        const file = this.historyFiles.find(f => f.filename === this.selectedFiles[0]);
                        if (file) {
                            // Route based on source
                            let url;
                            if (file.source === 'session' && file.session_id) {
                                url = `/api/session_download/${file.session_id}/${file.filename}`;
                            } else {
                                url = `/api/download/${file.filename}`;
                            }
                            window.location.href = url;
                            return;
                        }
                    }

                    // Multiple files: create archive
                    try {
                        const res = await fetch('/api/history/archive', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames: this.selectedFiles })
                        });
                        const data = await res.json();
                        if (data.success) {
                            window.location.href = data.download_url;
                        }
                    } catch (e) {
                        this.addLog('Archive failed', 'error');
                    }
                },

                startNextDevice() {
                    // Increment the start number
                    this.config.start_num = String(parseInt(this.config.start_num || 1) + 1);

                    // Reset UI state
                    this.isFlashing = false;
                    this.currentStep = 0;
                    this.errorStep = 0;
                    this.statusMessage = '';
                    this.statusHint = '';
                    this.statusBoxClass = 'info';
                    this.status = 'Ready';
                    this.downloadUrl = null;

                    // Clear logs
                    this.logs = [];

                    // DON'T regenerate sessionId - keep same batch/session!
                    // This allows history to accumulate: TEST01, TEST02, TEST03...
                    // this.sessionId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                    // localStorage.setItem('nrf5_session_id', this.sessionId);

                    // Refresh history to show all devices in this batch
                    this.fetchHistory();
                },

                confirmClearAll() {
                    if (this.historyFiles.length === 0) return;
                    if (confirm(`确定要清除所有历史记录吗？这将删除 ${this.historyFiles.length} 个文件，操作不可恢复。\n\nClear all ${this.historyFiles.length} history files? This cannot be undone.`)) {
                        this.clearAllHistory();
                    }
                },

                async clearAllHistory() {
                    try {
                        // Select all files and delete them
                        const files = this.historyFiles.map(f => ({
                            filename: f.filename,
                            source: f.source,
                            session_id: f.session_id
                        }));

                        const res = await fetch('/api/history/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files })
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.addLog(`已清除 ${data.deleted.length} 个历史文件`, 'success');
                            this.selectedFiles = [];
                            await this.fetchHistory();
                        } else {
                            this.addLog('清除失败', 'error');
                        }
                    } catch (e) {
                        console.error('Clear all error:', e);
                        this.addLog('清除失败', 'error');
                    }
                },

                confirmDelete() {
                    if (this.selectedFiles.length > 0) this.deleteModal = true;
                },

                async executeDelete() {
                    try {
                        const res = await fetch('/api/history/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames: this.selectedFiles })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.fetchHistory();
                            this.selectedFiles = [];
                            this.deleteModal = false;
                            this.addLog('Deleted ' + data.deleted.length + ' files', 'accent');
                        }
                    } catch (e) {
                        this.addLog('Delete failed', 'error');
                    }
                }
            }
        }
    </script>

    <!-- Manual ST-Link V2 Driver -->
    <script>
        class STLinkV2 {
            constructor(device) {
                this.device = device;
                this.epIn = null;
                this.epOut = null;
                this.cmdSize = 16;  // V2=16, V3=64
                this.opened = false;
            }

            async connect() {
                console.log('[ST-Link] Stage 1: Resetting USB state...');
                // Close and reopen to reset USB state
                if (this.device.opened) {
                    try { await this.device.close(); } catch (e) { }
                    await new Promise(r => setTimeout(r, 100));
                }

                console.log('[ST-Link] Stage 2: Opening device...');
                await this.device.open();

                console.log('[ST-Link] Stage 3: Selecting configuration...');
                if (!this.device.configuration) {
                    await this.device.selectConfiguration(1);
                }

                console.log('[ST-Link] Stage 4: Finding interface...');
                let iface = null;
                for (const i of this.device.configuration.interfaces) {
                    const alt = i.alternates[0];
                    if (alt.interfaceClass === 0xFF && alt.endpoints.length >= 2) {
                        iface = i;
                        break;
                    }
                }
                if (!iface) iface = this.device.configuration.interfaces[0];
                console.log(`[ST-Link] Using interface ${iface.interfaceNumber}`);

                console.log('[ST-Link] Stage 5: Claiming interface...');
                try { await this.device.releaseInterface(iface.interfaceNumber); } catch (e) { }
                await new Promise(r => setTimeout(r, 50));
                await this.device.claimInterface(iface.interfaceNumber);

                const endpoints = iface.alternates[0].endpoints;
                const epInDesc = endpoints.find(e => e.direction === 'in');
                const epOutDesc = endpoints.find(e => e.direction === 'out');
                if (!epInDesc || !epOutDesc) throw new Error('Endpoints not found');

                this.epIn = epInDesc.endpointNumber;
                this.epOut = epOutDesc.endpointNumber;

                // Detect V2 vs V3 based on packet size (V2=64 bytes, V3=512 or 1024)
                const outPktSize = epOutDesc.packetSize;
                this.cmdSize = outPktSize >= 512 ? 64 : 16;  // V3 uses 64-byte commands, V2 uses 16-byte
                console.log(`[ST-Link] Endpoints: In=${this.epIn}, Out=${this.epOut}, PktSize=${outPktSize}, CmdSize=${this.cmdSize}`);

                // Critical: Add stabilization delay for ALL ST-Link versions
                // WebUSB needs time after claiming interface before first transfer
                console.log('[ST-Link] Stage 6: USB stabilization (500ms)...');
                await new Promise(r => setTimeout(r, 500));

                console.log('[ST-Link] Stage 7: Version handshake...');
                try {
                    const versionResp = await this.sendCommand([0xf1], 6);
                    if (versionResp && versionResp.byteLength >= 2) {
                        const ver = versionResp.getUint16(0, true);
                        const major = (ver >> 12) & 0xF;
                        const swim = (ver >> 6) & 0x3F;
                        const jtag = ver & 0x3F;
                        console.log(`[ST-Link] Version: V${major}.J${jtag}`);
                    }

                    console.log('[ST-Link] Stage 7: Voltage check...');
                    try {
                        // 0xF7 = GET_TARGET_VOLTAGE (V2), some V2 clones may not support this
                        const vData = await this.sendCommand([0xf7], 8);
                        if (vData && vData.byteLength >= 8) {
                            const v1 = vData.getUint32(0, true);
                            const v2 = vData.getUint32(4, true);
                            if (v1 > 0) {
                                const voltage = (2.4 * v2 / v1).toFixed(2);
                                console.log(`[ST-Link] Target Voltage: ${voltage}V`);
                                if (window.alpineApp) window.alpineApp.addLog(`[ST-Link] Voltage: ${voltage}V`, parseFloat(voltage) < 2.0 ? 'warning' : 'success');
                            }
                        }
                    } catch (voltErr) {
                        console.warn('[ST-Link] Voltage check skipped (not supported)');
                    }

                    console.log('[ST-Link] Stage 8: Mode reset...');
                    const mode = await this.getMode();
                    if (mode !== 0x00) {
                        await this.exitMode();
                        await new Promise(r => setTimeout(r, 100));
                    }
                } catch (e) {
                    console.warn("[ST-Link] Handshake warn:", e.message);
                    await this.exitMode().catch(() => { });
                }
                this.opened = true;
                console.log('[ST-Link] Connection complete.');
            }

            async _write(data, timeout = 3000) {
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('USB Write Timeout')), timeout)
                );
                const writePromise = (async () => {
                    const res = await this.device.transferOut(this.epOut, data);
                    if (res.status !== 'ok') {
                        // On stall or error, log and throw - clearHalt often fails on macOS
                        console.warn(`[ST-Link] Write status: ${res.status}`);
                        throw new Error(`USB Out failed: ${res.status}`);
                    }
                })();
                return Promise.race([writePromise, timeoutPromise]);
            }

            async _read(len, timeout = 3000) {
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('USB Read Timeout')), timeout)
                );
                const readPromise = (async () => {
                    const res = await this.device.transferIn(this.epIn, len);
                    if (res.status !== 'ok') {
                        console.warn(`[ST-Link] Read status: ${res.status}`);
                        throw new Error(`USB In failed: ${res.status}`);
                    }
                    return res.data;
                })();
                return Promise.race([readPromise, timeoutPromise]);
            }

            async sendCommand(cmdArr, responseLen) {
                const buf = new Uint8Array(this.cmdSize);
                buf.set(cmdArr);
                console.log(`[ST-Link] CMD(${this.cmdSize}): ${cmdArr.map(x => x.toString(16)).join(' ')}`);
                await this._write(buf);
                if (responseLen > 0) return await this._read(responseLen);
                return null;
            }

            async getMode() {
                const res = await this.sendCommand([0xf5], 2);
                return (res && res.byteLength >= 1) ? res.getUint8(0) : 0;
            }

            async exitMode() {
                // STLINK_DEBUG_EXIT is 0x21
                await this.sendCommand([0xf2, 0x21], 0).catch(() => { });
            }

            async enterSWD() {
                // Ensure we are in a clean state
                await this.exitMode();
                await new Promise(r => setTimeout(r, 50));

                // ENTER_SWD: 0xf2 0x30 0xa3
                await this.sendCommand([0xf2, 0x30, 0xa3], 0);
                await new Promise(r => setTimeout(r, 50));
            }

            async readCoreId() {
                let lastError = null;
                for (let i = 0; i < 3; i++) {
                    try {
                        console.log(`[ST-Link] Reading CoreID (attempt ${i + 1}/3)...`);
                        const data = await this.sendCommand([0xf2, 0x22], 4);
                        if (data && data.byteLength >= 4) {
                            const coreId = data.getUint32(0, true);
                            if (coreId !== 0 && coreId !== 0xFFFFFFFF) {
                                return coreId;
                            }
                            console.warn(`[ST-Link] Invalid CoreID: 0x${coreId.toString(16)}`);
                        }
                    } catch (e) {
                        console.warn(`[ST-Link] CoreID attempt ${i + 1} failed:`, e.message);
                        lastError = e;
                    }
                    await new Promise(r => setTimeout(r, 200));
                }
                const errMsg = `SWD连接失败：无法读取目标芯片。\n\n请检查：\n1. SWDIO/SWCLK/GND 接线是否正确\n2. 目标芯片是否已供电 (3.3V)\n3. 芯片是否被读保护锁定`;
                if (window.alpineApp) window.alpineApp.addLog('[ST-Link] ❌ SWD 连接失败 - 检查接线和供电', 'error');
                throw new Error(lastError?.message || errMsg);
            }

            async writeMem32(addr, val) {
                const cmd = new Uint8Array(16);
                cmd.set([0xf2, 0x08, 0, 0, 0, 0, 4, 0]);
                const dv = new DataView(cmd.buffer);
                dv.setUint32(2, addr, true);

                await this.sendCommand(cmd, 0);
                const data = new Uint8Array(4);
                new DataView(data.buffer).setUint32(0, val, true);
                await this._write(data);
            }

            async readMem32(addr) {
                const cmd = new Uint8Array(16);
                cmd.set([0xf2, 0x07, 0, 0, 0, 0, 4, 0]);
                const dv = new DataView(cmd.buffer);
                dv.setUint32(2, addr, true);

                const data = await this.sendCommand(cmd, 4);
                if (!data || data.byteLength < 4) throw new Error("Read memory failed");
                return data.getUint32(0, true);
            }

            async writeMem(addr, data) {
                const cmd = new Uint8Array(16);
                cmd.set([0xf2, 0x08, 0, 0, 0, 0, 0, 0]);
                const dv = new DataView(cmd.buffer);
                dv.setUint32(2, addr, true);
                dv.setUint16(6, data.length, true);

                await this.sendCommand(cmd, 0);
                await this._write(data);
            }

            async reset() {
                await this.sendCommand([0xf2, 0x03], 0); // RESET
            }
        }
    </script>
</body>

</html>