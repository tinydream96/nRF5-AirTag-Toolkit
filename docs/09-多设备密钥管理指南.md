# 多设备密钥管理指南

## 概述

本项目支持为不同设备生成和使用独立的密钥文件。每个设备都有唯一的密钥文件名和内容，确保设备间的安全隔离。

## 设备命名规范

### 命名要求
- 长度：3-20 个字符
- 字符：只能包含大写字母、数字、下划线
- 示例：`DEVICE01`、`MY_AIRTAG`、`TEST123`

### 文件命名规则
对于设备名称 `DEVICE01`，会生成以下文件：
- `DEVICE01_keyfile` - 二进制密钥文件（用于刷写固件）
- `DEVICE01.keys` - 文本格式密钥（用于查看和备份）
- `DEVICE01_devices.json` - 设备配置文件（用于 AirTag 应用）

## 快速开始

### 方法一：一键设置（推荐）
```bash
# 完整设置一个设备（生成密钥 + 编译 + 刷写）
./scripts/setup_device.sh DEVICE01 200

# 交互式设置
./scripts/setup_device.sh
```

### 方法二：分步操作
```bash
# 1. 生成设备密钥
./scripts/generate_device_keys.sh DEVICE01 200

# 2. 编译和刷写
./scripts/compile_and_flash_device.sh DEVICE01

# 3. 或使用快速刷写（2秒广播间隔）
./scripts/compile_and_flash_2s.sh DEVICE01
```

## 密钥管理

### 生成新设备密钥
```bash
# 基本用法
./scripts/generate_device_keys.sh [设备名称] [密钥数量]

# 示例
./scripts/generate_device_keys.sh DEVICE01 200
./scripts/generate_device_keys.sh MYAIRTAG 150
./scripts/generate_device_keys.sh TEST_DEVICE 100
```

### 查看所有设备密钥
```bash
./scripts/list_device_keys.sh
```

输出示例：
```
🔑 设备密钥文件列表
====================

📱 设备: DEVICE01
  📄 密钥文件: DEVICE01_keyfile (5.6K)
  🔑 密钥数量: 200
  📋 配置文件: DEVICE01_devices.json
  📅 修改时间: 2024-01-15 10:30:45

📱 设备: MYAIRTAG
  📄 密钥文件: MYAIRTAG_keyfile (4.2K)
  🔑 密钥数量: 150
  📋 配置文件: MYAIRTAG_devices.json
  📅 修改时间: 2024-01-15 09:15:22
```

## 编译和刷写

### 使用设备专用脚本
```bash
# 编译和刷写指定设备
./scripts/compile_and_flash_device.sh DEVICE01

# 快速刷写（2秒广播间隔）
./scripts/compile_and_flash_2s.sh DEVICE01
```

### 手动编译
```bash
# 切换到编译目录
cd heystack-nrf5x/nrf52810/armgcc

# 复制设备密钥文件
cp ../../../config/DEVICE01_keyfile ./

# 编译和刷写
make stflash-nrf52810_xxaa-patched \
    HAS_DCDC=0 \
    HAS_BATTERY=1 \
    KEY_ROTATION_INTERVAL=300 \
    MAX_KEYS=200 \
    ADVERTISING_INTERVAL=2000 \
    ADV_KEYS_FILE=./DEVICE01_keyfile
```

## 文件结构

```
project/
├── config/                          # 密钥文件存储目录
│   ├── DEVICE01_keyfile             # 设备01密钥文件
│   ├── DEVICE01.keys                # 设备01文本密钥
│   ├── DEVICE01_devices.json        # 设备01配置文件
│   ├── MYAIRTAG_keyfile             # 设备02密钥文件
│   ├── MYAIRTAG.keys                # 设备02文本密钥
│   └── MYAIRTAG_devices.json        # 设备02配置文件
├── scripts/                         # 管理脚本
│   ├── setup_device.sh              # 一键设备设置
│   ├── generate_device_keys.sh      # 生成设备密钥
│   ├── compile_and_flash_device.sh  # 编译刷写设备
│   ├── compile_and_flash_2s.sh      # 快速刷写
│   └── list_device_keys.sh          # 列出所有设备
└── heystack-nrf5x/nrf52810/armgcc/  # 编译目录
    ├── DEVICE01_keyfile             # 当前编译使用的密钥
    └── ...
```

## 最佳实践

### 1. 设备命名
- 使用有意义的名称：`OFFICE_TAG`、`CAR_TRACKER`
- 包含版本信息：`DEVICE_V1`、`PROTOTYPE_02`
- 避免特殊字符和空格

### 2. 密钥管理
- 定期备份密钥文件到安全位置
- 为不同用途的设备使用不同的密钥数量
- 记录设备与密钥文件的对应关系

### 3. 开发流程
```bash
# 开发新设备
./scripts/setup_device.sh NEW_DEVICE 200

# 快速测试
./scripts/compile_and_flash_2s.sh NEW_DEVICE

# 生产部署
./scripts/compile_and_flash_device.sh NEW_DEVICE
```

## 故障排除

### 常见问题

#### 1. 密钥文件未找到
```
❌ 错误: 密钥文件 DEVICE01_keyfile 未找到
```
**解决方案：**
```bash
# 生成密钥文件
./scripts/generate_device_keys.sh DEVICE01

# 或复制现有文件
cp config/DEVICE01_keyfile heystack-nrf5x/nrf52810/armgcc/
```

#### 2. 设备名称格式错误
```
❌ 设备名称格式错误
```
**解决方案：**
- 确保名称为3-20个字符
- 只使用大写字母、数字、下划线
- 示例：`DEVICE01`、`MY_TAG`

#### 3. 密钥数量超出范围
```
❌ 密钥数量必须是 1-250 之间的数字
```
**解决方案：**
```bash
# 使用合理的密钥数量
./scripts/generate_device_keys.sh DEVICE01 200
```

### 验证设备设置
```bash
# 检查密钥文件
ls -la config/DEVICE01_keyfile

# 检查编译目录
ls -la heystack-nrf5x/nrf52810/armgcc/DEVICE01_keyfile

# 查看所有设备
./scripts/list_device_keys.sh
```

## 迁移指南

### 从单设备迁移到多设备

如果您之前使用固定的 `R0VVSW_keyfile`，可以按以下步骤迁移：

```bash
# 1. 备份现有密钥文件
cp config/R0VVSW_keyfile config/R0VVSW_keyfile.backup

# 2. 使用新的脚本管理设备
./scripts/list_device_keys.sh

# 3. 为新设备生成密钥
./scripts/generate_device_keys.sh NEW_DEVICE 200

# 4. 使用设备专用脚本
./scripts/compile_and_flash_device.sh NEW_DEVICE
```

### 批量设备设置
```bash
#!/bin/bash
# 批量设置多个设备

devices=("DEVICE01" "DEVICE02" "DEVICE03")
key_count=200

for device in "${devices[@]}"; do
    echo "设置设备: $device"
    ./scripts/setup_device.sh "$device" "$key_count"
    echo "设备 $device 设置完成"
    echo "---"
done
```

## 总结

多设备密钥管理功能让您能够：
- 为每个设备生成独立的密钥
- 安全地管理多个设备
- 简化开发和部署流程
- 提高设备间的安全隔离

使用 `./scripts/setup_device.sh` 开始您的多设备开发之旅！