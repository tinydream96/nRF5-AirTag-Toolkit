# nRF52832 固件制作与刷机指南

## 概述

本文档详细说明了如何为nRF52832芯片制作固件和进行刷机操作。nRF52832使用nRF5 SDK 15.3.0和S132 SoftDevice。

## 前置条件

### 硬件要求
- nRF52832开发板或模块
- ST-Link调试器 或 J-Link调试器
- USB连接线

### 软件要求
- ARM GCC工具链
- OpenOCD (用于ST-Link) 或 nRF Command Line Tools (用于J-Link)
- mergehex工具
- hex2bin.py脚本

## 固件制作命令

### 基本编译命令

```bash
# 清理并编译固件
make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile
```

### 可用的固件变体

1. **标准版本 (nrf52832_xxaa)**
   ```bash
   make -C heystack-nrf5x/nrf52832/armgcc nrf52832_xxaa HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile
   ```

2. **DCDC版本 (nrf52832_xxaa-dcdc)**
   ```bash
   make -C heystack-nrf5x/nrf52832/armgcc nrf52832_xxaa-dcdc HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile
   ```

3. **YJ17024版本 (nrf52832_yj17024)**
   ```bash
   make -C heystack-nrf5x/nrf52832/armgcc nrf52832_yj17024 HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile
   ```

## 刷机命令

### 方法1: 使用OpenOCD (ST-Link调试器)

#### 一键制作并刷写
```bash
# 标准版本
make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_xxaa-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile
========================================================================================================
# DCDC版本
make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_xxaa-dcdc-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=2010 ADV_KEYS_FILE=../../../config/BFX001_keyfile

make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_xxaa-dcdc-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=2020 ADV_KEYS_FILE=../../../config/BFX002_keyfile

make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_xxaa-dcdc-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=3010 ADV_KEYS_FILE=../../../config/CIR001_keyfile
make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_xxaa-dcdc-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=3500 ADV_KEYS_FILE=../../../config/CIR050_keyfile





========================================================================================================

# YJ17024版本
make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_yj17024-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile
```

#### 分步操作
```bash
# 1. 制作带密钥的固件
make -C heystack-nrf5x/nrf52832/armgcc patched_nrf52832_xxaa HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile

# 2. 手动刷写
cd heystack-nrf5x/nrf52832/armgcc
openocd -f openocd.cfg -c "init; halt; nrf51 mass_erase; program _build/nrf52832_xxaa_s132_patched.bin verify; reset; exit"
```

### 方法2: 使用J-Link Commander (推荐)

```bash
# 1. 制作带密钥的固件
make -C heystack-nrf5x/nrf52832/armgcc patched_nrf52832_xxaa HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=3010 ADV_KEYS_FILE=../../../config/BND001_keyfile

# 2. 启动J-Link Commander
JLinkExe -device nrf52832_xxaa -if swd -speed 4000

# 3. 在J-Link Commander中执行以下命令:
# connect
# erase
# loadbin heystack-nrf5x/nrf52832/armgcc/_build/nrf52832_xxaa_s132_patched.bin 0x0
# r
# g
# exit
```

### 方法3: 使用nrfjprog (J-Link调试器) - 备选方案

```bash
# 1. 制作带密钥的固件
make -C heystack-nrf5x/nrf52832/armgcc patched_nrf52832_xxaa HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile

# 2. 擦除芯片
nrfjprog -f nrf52 --eraseall

# 3. 刷写固件
nrfjprog -f nrf52 --program heystack-nrf5x/nrf52832/armgcc/_build/nrf52832_xxaa_s132_patched.bin --sectorerase

# 4. 复位芯片
nrfjprog -f nrf52 --reset
```

**注意**: 如果nrfjprog出现连接问题，建议使用J-Link Commander方法。

### 方法4: 使用Black Magic Probe

```bash
# 1. 制作带密钥的固件
make -C heystack-nrf5x/nrf52832/armgcc patched_nrf52832_xxaa HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile

# 2. 使用BMP刷写
make -C heystack-nrf5x/nrf52832/armgcc bmpflash-nrf52832_xxaa-patched BMP_PORT=/dev/cu.usbmodem*1
```

## 参数配置说明

### 编译参数

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `HAS_DCDC` | 启用DCDC转换器 | 0 | `HAS_DCDC=1` |
| `HAS_BATTERY` | 启用电池电压监测 | 0 | `HAS_BATTERY=1` |
| `KEY_ROTATION_INTERVAL` | 密钥轮换间隔(秒) | 0 | `KEY_ROTATION_INTERVAL=900` |
| `MAX_KEYS` | 最大密钥数量 | 0 | `MAX_KEYS=200` |
| `ADVERTISING_INTERVAL` | 广播间隔(毫秒) | 0 | `ADVERTISING_INTERVAL=1010` |
| `ADV_KEYS_FILE` | 密钥文件路径 | - | `ADV_KEYS_FILE=../../../config/BND001_keyfile` |
| `HAS_DEBUG` | 启用调试输出 | 0 | `HAS_DEBUG=1` |
| `RANDOM_ROTATE_KEYS` | 随机密钥轮换 | 1 | `RANDOM_ROTATE_KEYS=0` |

### 设备配置文件

密钥文件位置：`config/` 目录下
- `BND001_keyfile` - BND001设备密钥
- `EPD001_keyfile` - EPD001设备密钥
- `HEM001_keyfile` - HEM001设备密钥
- 等等...

## 输出文件说明

编译成功后，在 `heystack-nrf5x/nrf52832/armgcc/_build/` 目录下会生成：

| 文件 | 说明 |
|------|------|
| `nrf52832_xxaa.out` | ELF格式的应用程序 |
| `nrf52832_xxaa.hex` | HEX格式的应用程序 |
| `nrf52832_xxaa.bin` | BIN格式的应用程序 |
| `nrf52832_xxaa_s132.hex` | 应用程序+SoftDevice合并文件 |
| `nrf52832_xxaa_s132.bin` | 应用程序+SoftDevice合并文件(二进制) |
| `nrf52832_xxaa_s132_patched.bin` | 打补丁后的最终固件 |
| `nrf52832_xxaa_s132_patched.elf` | 打补丁后的ELF文件 |

## 技术规格

### nRF52832芯片信息
- **CPU**: ARM Cortex-M4F @ 64MHz
- **Flash**: 512KB
- **RAM**: 64KB
- **SoftDevice**: S132 v6.1.1
- **协议栈**: BLE 5.0

### 内存布局
- **SoftDevice**: 0x00000000 - 0x00026000
- **Application**: 0x00026000 - 0x0007F000
- **Settings**: 0x0007F000 - 0x00080000

## 故障排除

### 常见错误及解决方案

1. **`No such file or directory: Makefile.common`**
   - 检查SDK路径配置
   - 确保使用正确的相对路径

2. **`Error: open failed` (OpenOCD)**
   - 检查ST-Link连接
   - 确认调试器驱动已安装
   - 检查目标板电源

3. **`nrfjprog: command not found`**
   - 安装nRF Command Line Tools
   - 检查PATH环境变量

4. **密钥文件不存在**
   - 确认密钥文件路径正确
   - 使用 `generate_device_keys.sh` 生成密钥

### 调试命令

```bash
# 查看可用目标
make -C heystack-nrf5x/nrf52832/armgcc help

# 检查编译环境
arm-none-eabi-gcc --version

# 检查调试器连接
nrfjprog --ids  # J-Link
# 或
openocd -f interface/stlink.cfg -f target/nrf52.cfg -c "init; halt; exit"  # ST-Link
```

## 快速参考

### 最常用命令

```bash
# 快速编译和刷写 (推荐)
make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc stflash-nrf52832_xxaa-patched HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile

# 仅编译
make -C heystack-nrf5x/nrf52832/armgcc clean && make -C heystack-nrf5x/nrf52832/armgcc HAS_DCDC=1 HAS_BATTERY=1 KEY_ROTATION_INTERVAL=900 MAX_KEYS=200 ADVERTISING_INTERVAL=1010 ADV_KEYS_FILE=../../../config/BND001_keyfile

# 清理编译文件
make -C heystack-nrf5x/nrf52832/armgcc clean
```

---

**注意**: 请根据实际硬件配置选择合适的固件变体和刷机方法。建议在正式部署前先在测试设备上验证固件功能。