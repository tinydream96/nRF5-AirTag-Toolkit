# nRF52810 固件编译指南

## 📋 概述
本文档详细说明 heystack-nrf5x 固件的编译过程，包括参数配置、SoftDevice 合并和密钥补丁机制。

## 🧩 固件架构理解

### nRF52810 Flash 内存布局
```
Flash 内存 (192KB)
┌─────────────────────────┐ 0x00000000
│                         │
│     SoftDevice          │ ← 蓝牙协议栈 (~100KB)
│     (S112 v6.1.1)       │   Nordic 预编译固件
│                         │
├─────────────────────────┤ 0x00019000
│                         │
│   应用程序固件           │ ← heystack-nrf5x 代码
│   (heystack-nrf5x)      │   我们编译的部分
│                         │
└─────────────────────────┘ 0x00030000
```

### SoftDevice 作用
- **蓝牙协议栈**: 处理 BLE 通信协议
- **射频管理**: 控制 2.4GHz 无线电
- **系统服务**: 定时器、中断、电源管理
- **硬件抽象**: 封装芯片底层操作

## 🔧 编译参数详解

### 基础参数
```bash
HAS_DCDC=0              # 稳压器选择: 0=LDO, 1=DC/DC
HAS_BATTERY=1           # 电量报告: 0=禁用, 1=启用
HAS_DEBUG=0             # 调试模式: 0=禁用, 1=启用
```

### 功能参数
```bash
KEY_ROTATION_INTERVAL=300    # 密钥轮换间隔(秒): 300=5分钟
MAX_KEYS=200                # 最大密钥数量: 建议200
ADVERTISING_INTERVAL=2000   # 广播间隔(毫秒): 2000=2秒
```

### 文件参数
```bash
ADV_KEYS_FILE=./R0VVSW_keyfile  # 密钥文件路径
BOARD=custom_board              # 开发板配置
```

## 🏗️ 编译流程详解

### 步骤 1: 基础编译
```bash
cd heystack-nrf5x/nrf52810/armgcc
make clean
make nrf52810_xxaa [参数...]
```

**生成文件**:
- `_build/nrf52810_xxaa.hex` - 应用程序固件
- `_build/nrf52810_xxaa.bin` - 二进制格式
- `_build/nrf52810_xxaa.out` - ELF 可执行文件

### 步骤 2: 合并 SoftDevice
```bash
make merge_nrf52810_xxaa
```

**执行过程**:
```bash
mergehex -m _build/nrf52810_xxaa.hex \
../../../nrf-sdk/nRF5_SDK_15.3.0_59ac345/components/softdevice/s112/hex/s112_nrf52_6.1.1_softdevice.hex \
-o _build/nrf52810_xxaa_s112.hex
```

**工具说明**:
- `mergehex`: Nordic 提供的 hex 文件合并工具
- 安装方式: `brew install --cask nordic-nrf-command-line-tools`

**生成文件**:
- `_build/nrf52810_xxaa_s112.hex` - 完整固件(应用+协议栈)

### 步骤 3: 转换为二进制
```bash
make bin_nrf52810_xxaa
```

**执行过程**:
```bash
hex2bin.py _build/nrf52810_xxaa_s112.hex _build/nrf52810_xxaa_s112.bin
```

**工具说明**:
- `hex2bin.py`: Python hex 到二进制转换工具
- 依赖: `intelhex` Python 包
- 安装方式: `pip3 install intelhex`

**生成文件**:
- `_build/nrf52810_xxaa_s112.bin` - 二进制完整固件

### 步骤 4: 密钥补丁
```bash
make patched_nrf52810_xxaa ADV_KEYS_FILE=./R0VVSW_keyfile
```

**执行过程**:
1. 复制二进制文件为补丁版本
2. 在固件中查找占位符 `OFFLINEFINDINGPUBLICKEYHERE!`
3. 用实际密钥数据替换占位符
4. 验证补丁是否成功

**生成文件**:
- `_build/nrf52810_xxaa_s112_patched.bin` - 最终固件
- `_build/nrf52810_xxaa_s112_patched.elf` - ELF 格式

## 🎯 编译命令示例

### 基础编译 (无密钥)
```bash
make nrf52810_xxaa \
    HAS_DCDC=0 \
    HAS_BATTERY=1 \
    KEY_ROTATION_INTERVAL=300 \
    MAX_KEYS=200 \
    ADVERTISING_INTERVAL=2000
```

### 完整编译 (含密钥，不刷写)
```bash
make patched_nrf52810_xxaa \
    HAS_DCDC=0 \
    HAS_BATTERY=1 \
    KEY_ROTATION_INTERVAL=300 \
    MAX_KEYS=200 \
    ADVERTISING_INTERVAL=2000 \
    ADV_KEYS_FILE=./R0VVSW_keyfile
```

### 编译+刷写 (一步完成)
```bash
make stflash-nrf52810_xxaa-patched \
    HAS_DCDC=0 \
    HAS_BATTERY=1 \
    KEY_ROTATION_INTERVAL=300 \
    MAX_KEYS=200 \
    ADVERTISING_INTERVAL=2000 \
    ADV_KEYS_FILE=./R0VVSW_keyfile
```

## 🔍 编译输出分析

### 成功编译的标志
```
Linking target: _build/nrf52810_xxaa.out
   text	   data	    bss	    dec	    hex	filename
  15832	     64	    776	  16672	   4120	_build/nrf52810_xxaa.out
Preparing: _build/nrf52810_xxaa.hex
Preparing: _build/nrf52810_xxaa.bin
DONE nrf52810_xxaa
```

### 内存使用分析
- **text**: 代码段大小 (15832 字节)
- **data**: 初始化数据 (64 字节)
- **bss**: 未初始化数据 (776 字节)
- **总计**: 16672 字节 (~16KB)

### 文件大小参考
```bash
ls -lh _build/
# nrf52810_xxaa.hex          ~44KB  (应用程序)
# nrf52810_xxaa_s112.hex     ~144KB (应用+SoftDevice)
# nrf52810_xxaa_s112.bin     ~100KB (二进制格式)
```

## ⚠️ 编译故障排除

### 错误 1: 工具链未找到
```
make: arm-none-eabi-gcc: Command not found
```
**解决**: 检查 `Makefile.posix` 中的 `GNU_INSTALL_ROOT`

### 错误 2: SDK 路径错误
```
Makefile.common: No such file or directory
```
**解决**: 检查项目 `Makefile` 中的 `SDK_ROOT`

### 错误 3: 密钥文件未找到
```
The file ./R0VVSW_keyfile does not exist!
```
**解决**: 确保密钥文件在正确位置

### 错误 4: Nordic 工具缺失
```
mergehex: No such file or directory
```
**解决**: 安装 Nordic 命令行工具
```bash
brew install --cask nordic-nrf-command-line-tools
```

### 错误 5: Python 工具缺失
```
hex2bin.py: No such file or directory
```
**解决**: 安装 intelhex Python 包
```bash
pip3 install intelhex
```

### 错误 6: 密钥补丁失败
```
The key was not patched correctly!
```
**解决**: 检查密钥文件格式，手动执行补丁
```bash
tail -c +2 ./R0VVSW_keyfile | dd of=_build/nrf52810_xxaa_s112_patched.bin bs=1 seek=112472 conv=notrunc
```

### 错误 7: 链接错误
```
undefined reference to `xxx`
```
**解决**: 检查源文件包含和库依赖

## 🎛️ 高级编译选项

### 调试版本编译
```bash
make stflash-nrf52810_xxaa-patched \
    HAS_DEBUG=1 \
    [其他参数...]
```

### DC/DC 模式 (省电)
```bash
make stflash-nrf52810_xxaa-dcdc-patched \
    HAS_DCDC=1 \
    [其他参数...]
```

### 自定义开发板
```bash
make stflash-nrf52810_xxaa-patched \
    BOARD=my_custom_board \
    [其他参数...]
```

## 📊 性能优化建议

### 电池寿命优化
- 使用 `HAS_DCDC=1` (如果硬件支持)
- 增加 `ADVERTISING_INTERVAL` (减少广播频率)
- 减少 `MAX_KEYS` (节省内存)

### 响应速度优化
- 减少 `ADVERTISING_INTERVAL` (增加广播频率)
- 减少 `KEY_ROTATION_INTERVAL` (更频繁更新)

## 📝 下一步

编译完成后，请参考：
- `04-硬件连接与刷写.md` - 连接硬件并刷写固件
- `05-快速参考手册.md` - 常用命令速查

---
*最后更新: 2024年7月*