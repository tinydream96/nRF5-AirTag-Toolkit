# nRF52810 硬件连接与刷写指南

## 📋 概述
本文档详细说明如何连接 ST-Link V2 调试器与 nRF52810 开发板，并进行固件刷写。

## 🔌 硬件连接

### 必需硬件
- **ST-Link V2** 调试器/编程器
- **nRF52810** 开发板或模块
- **杜邦线** 4根 (公对公或公对母)

### 引脚连接图
```
ST-Link V2          nRF52810
┌─────────────┐    ┌─────────────┐
│     3.3V    │────│  VDD/VCC    │  电源正极
│     GND     │────│  GND/VSS    │  电源地
│    SWDIO    │────│   SWDIO     │  串行调试数据 (P0.18)
│    SWCLK    │────│   SWCLK     │  串行调试时钟 (P0.16)
└─────────────┘    └─────────────┘
```

### 详细引脚说明

| ST-Link V2 | nRF52810 | 功能 | 备注 |
|------------|----------|------|------|
| 3.3V | VDD/VCC | 电源正极 | 提供3.3V电源 |
| GND | GND/VSS | 电源地 | 共同接地 |
| SWDIO | P0.18 | 串行调试数据 | SWD 数据线 |
| SWCLK | P0.16 | 串行调试时钟 | SWD 时钟线 |

### 连接注意事项
1. **电源电压**: 确保使用 3.3V，不要使用 5V
2. **接地**: GND 必须连接，否则无法通信
3. **线序**: 确保 SWDIO 和 SWCLK 不要接反
4. **接触**: 确保连接牢固，避免接触不良

## 🔍 连接验证

### 检测 ST-Link 硬件
```bash
# 检查 USB 设备
system_profiler SPUSBDataType | grep -i stlink
```

**预期输出**:
```
STM32 STLink:
```

### 测试 OpenOCD 连接
```bash
cd heystack-nrf5x/nrf52810/armgcc

# 测试连接 (不连接目标芯片)
openocd -f interface/stlink.cfg -f target/nrf52.cfg -c "init; targets; exit"
```

**仅 ST-Link 连接时的输出**:
```
Info : STLINK V2J46S7 (API v2) VID:PID 0483:3748
Info : Target voltage: 3.168992
Error: init mode failed (unable to connect to the target)
```

**ST-Link + nRF52810 连接时的输出**:
```
Info : STLINK V2J46S7 (API v2) VID:PID 0483:3748
Info : Target voltage: 3.168992
Info : nrf52.cpu: hardware has 6 breakpoints, 4 watchpoints
Info : starting gdb server for nrf52.cpu on 3333
```

## 🔥 固件刷写

### 方法 1: 一键刷写 (推荐)
```bash
cd heystack-nrf5x/nrf52810/armgcc

# 使用便捷脚本
../../../compile_and_flash_2s.sh
```

### 方法 2: 完整命令
```bash
cd heystack-nrf5x/nrf52810/armgcc

# 完整编译+刷写流程
make stflash-nrf52810_xxaa-patched \
    HAS_DCDC=0 \
    HAS_BATTERY=1 \
    KEY_ROTATION_INTERVAL=300 \
    MAX_KEYS=200 \
    ADVERTISING_INTERVAL=2000 \
    ADV_KEYS_FILE=./R0VVSW_keyfile
```

### 方法 3: 仅刷写已编译固件
```bash
# 如果固件已编译，只需刷写
openocd -f openocd.cfg -c "init; halt; nrf51 mass_erase; program _build/nrf52810_xxaa_s112_patched.bin verify; reset; exit"
```

## ✅ 刷写成功标志

### 成功的输出示例
```
Open On-Chip Debugger 0.12.0
Info : auto-selecting first available session transport "hla_swd"
Info : The selected transport took over low-level target control
Info : clock speed 1000 kHz
Info : STLINK V2J46S7 (API v2) VID:PID 0483:3748
Info : Target voltage: 3.168992
Info : nrf52.cpu: hardware has 6 breakpoints, 4 watchpoints
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0xfffffffe msp: 0xfffffffc
Info : Mass erase completed.
Info : Programming Started
Info : Programming Finished
Info : Verified OK
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0xfffffffe msp: 0xfffffffc
```

### 关键成功指标
- ✅ `Target voltage: 3.168992` - 检测到目标电压
- ✅ `Mass erase completed` - 芯片擦除成功
- ✅ `Programming Finished` - 编程完成
- ✅ `Verified OK` - 验证成功

## 🐛 故障排除

### 错误 1: 无法连接目标
```
Error: init mode failed (unable to connect to the target)
```

**可能原因**:
- nRF52810 未连接或连接错误
- 电源未供应
- SWDIO/SWCLK 接线错误

**解决方案**:
1. 检查所有连接线
2. 确认电源供应 (3.3V)
3. 尝试重新连接

### 错误 2: 目标电压异常
```
Info : Target voltage: 0.000000
```

**可能原因**:
- 电源线未连接
- nRF52810 损坏
- ST-Link 故障

**解决方案**:
1. 检查 3.3V 和 GND 连接
2. 用万用表测量电压
3. 更换连接线

### 错误 3: 编程失败
```
Error: Programming failed
```

**可能原因**:
- 芯片保护启用
- 连接不稳定
- 固件文件损坏

**解决方案**:
1. 尝试 mass erase: `nrf51 mass_erase`
2. 检查连接稳定性
3. 重新编译固件

### 错误 4: 验证失败
```
Error: Verification failed
```

**可能原因**:
- 刷写过程中断
- 硬件问题
- 固件文件问题

**解决方案**:
1. 重新刷写
2. 检查硬件连接
3. 重新编译固件

## 🔧 高级刷写选项

### 使用 Black Magic Probe
```bash
make bmpflash-nrf52810_xxaa-patched \
    BMP_PORT=/dev/cu.usbmodem* \
    [其他参数...]
```

### 手动 OpenOCD 命令
```bash
# 连接
openocd -f openocd.cfg

# 在另一个终端执行
telnet localhost 4444

# OpenOCD 命令
> halt
> nrf51 mass_erase
> program _build/nrf52810_xxaa_s112_patched.bin
> verify_image _build/nrf52810_xxaa_s112_patched.bin
> reset
> exit
```

### 批量刷写脚本
```bash
#!/bin/bash
# 批量刷写多个设备
for i in {1..10}; do
    echo "刷写设备 $i"
    make stflash-nrf52810_xxaa-patched [参数...]
    echo "请更换设备，按回车继续..."
    read
done
```

## 📊 刷写性能

### 典型刷写时间
- **擦除**: ~2秒
- **编程**: ~10秒
- **验证**: ~5秒
- **总计**: ~17秒

### 优化建议
- 使用稳定的 USB 连接
- 避免在刷写过程中移动设备
- 确保电源稳定

## 🔍 调试和监控

### RTT 日志监控
```bash
# 刷写调试版本固件
make stflash-nrf52810_xxaa-patched HAS_DEBUG=1 [其他参数...]

# 监控日志
make rtt-monitor
```

### 预期日志输出
```
<info> app: Starting advertising
<info> app: ble_set_mac_address: XX:XX:XX:XX:XX:XX
<info> app: ble_set_max_tx_power: 4 dBm
<info> app: Rotating key: 1
```

## 📝 刷写检查清单

刷写前确认：
- [ ] ST-Link V2 已连接到电脑
- [ ] nRF52810 正确连接到 ST-Link
- [ ] 所有连接线牢固
- [ ] 固件已成功编译
- [ ] 密钥文件在正确位置

刷写后验证：
- [ ] 看到 "Programming Finished"
- [ ] 看到 "Verified OK"
- [ ] 设备重启正常
- [ ] RTT 日志正常 (如果启用调试)

## 📝 下一步

刷写完成后，请参考：
- `05-快速参考手册.md` - 常用命令和故障排除
- `06-技术原理解析.md` - 深入了解技术细节

---
*最后更新: 2024年7月*