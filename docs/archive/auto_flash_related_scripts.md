
# 刷写相关脚本说明

本文档介绍了与`auto_flash.sh`脚本相关联的一系列脚本，这些脚本共同构成了nRF5系列芯片固件刷写的完整流程。

## 脚本概览

| 脚本文件名 | 主要功能 |
| :--- | :--- |
| `auto_flash.sh` | **(主入口)** 提供一个交互式菜单，引导用户完成从密钥生成到固件刷写的整个自动化流程。 |
| `compile_and_flash_2s.sh` | 编译并刷写固件，使用固定的2秒广播间隔。 |
| `compile_and_flash_device.sh` | 提供更灵活的编译和刷写选项，允许自定义广播间隔、调试模式等。 |
| `setup_device.sh` | 一体化设置新设备，包括生成密钥、编译和刷写。 |
| `generate_device_keys.sh` | 为指定的设备生成密钥文件。 |
| `quick_chip_recovery.sh` | 解除芯片的读写保护，以便刷写新固件。 |

## 脚本详解

### 1. `auto_flash.sh`

这是一个高级自动化脚本，作为刷写流程的主要入口点。

**功能:**

*   **交互式菜单:** 提供一个用户友好的菜单，用于选择现有密钥或生成新密钥。
*   **环境检查:** 自动检查所需工具和库（如Python, `cryptography`）是否已安装。
*   **流程编排:** 按顺序调用其他脚本来执行特定任务：
    1.  调用 `quick_chip_recovery.sh` 解除芯片保护。
    2.  调用 `compile_and_flash_2s.sh` 编译和刷写固件。

**使用场景:**

当您想要一个简单、引导式的操作来完成整个刷写过程时，应首先考虑使用此脚本。

### 2. `compile_and_flash_2s.sh`

此脚本专注于以固定的2秒广播间隔编译和刷写固件。

**功能:**

*   **固定参数编译:** 使用预设的参数（特别是2秒的广播间隔）进行固件编译。
*   **设备选择:** 允许用户从现有的密钥文件中选择要刷写的设备。
*   **直接刷写:** 调用 `make` 命令执行编译和刷写操作。

**使用场景:**

当您需要快速地以标准配置（2秒间隔）刷写一个已经生成过密钥的设备时，可以使用此脚本。`auto_flash.sh` 在内部调用它来完成刷写步骤。

### 3. `compile_and_flash_device.sh`

这是一个功能更强大、更灵活的编译和刷写脚本。

**功能:**

*   **参数化编译:** 允许通过命令行标志自定义各种编译选项，例如：
    *   `--debug`: 启用调试模式。
    *   `--interval <ms>`: 设置广播间隔（毫秒）。
    *   `--dcdc`: 启用DC/DC转换器以降低功耗。
*   **设备选择:** 与其他脚本一样，需要指定一个设备名称。

**使用场景:**

当您需要对固件进行精细控制时（例如，为了调试而启用日志输出，或为了省电而调整广播间隔），应使用此脚本。

### 4. `setup_device.sh`

这是一个一体化的设备初始化脚本，适用于首次设置新设备。

**功能:**

*   **端到端设置:** 将新设备的设置流程整合到一个命令中。
*   **调用其他脚本:**
    1.  调用 `generate_device_keys.sh` 为新设备创建密钥。
    2.  调用 `compile_and_flash_device.sh` 使用生成的密钥编译和刷写固件。

**使用场景:**

当您拿到一个全新的nRF芯片并希望将其设置为一个新的AirTag设备时，使用此脚本可以简化整个过程。

### 5. `generate_device_keys.sh`

*推断功能，未直接阅读*

此脚本负责为指定的设备生成加密密钥。

**功能:**

*   **生成密钥:** 创建一个包含多个密钥的 `_keyfile` 文件，用于AirTag的广播。
*   **设备命名:** 允许为生成的密钥文件指定一个唯一的设备名称。

**使用场景:**

在刷写任何设备之前，必须先为其生成密钥。此脚本是 `setup_device.sh` 和 `auto_flash.sh`（在生成新密钥时）流程的第一步。

### 6. `quick_chip_recovery.sh`

*推断功能，未直接阅读*

此脚本用于恢复被保护的nRF芯片。

**功能:**

*   **解除保护:** 移除nRF芯片的读/写保护，使其能够被重新刷写。这通常是通过 `nrfjprog --recover` 命令完成的。

**使用场景:**

在刷写固件之前，特别是对于一个全新的或者被锁定的芯片，必须先运行此恢复过程。`auto_flash.sh` 会自动执行此步骤。

