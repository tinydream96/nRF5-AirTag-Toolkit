# J-Link 刷写指南 (nRF52810/nRF52832)

本文档详细介绍了使用 J-Link 调试器配合自动化脚本进行批量刷写的流程。

## 📋 脚本概览

本项目提供了两个针对不同芯片的专用 J-Link 脚本：

| 脚本文件 | 适用芯片 | 说明 |
| :--- | :--- | :--- |
| `n52810autoflash_jlink.sh` | **nRF52810** | 适用于 nRF52810 模块 |
| `n52832autoflash_jlink.sh` | **nRF52832** | 适用于 nRF52832 模块 (支持手动解锁) |

这些脚本集成了以下功能：

- 自动检测 J-Link 连接
- 自动编译固件
- **智能解锁 (Recover)**: 自动处理芯片读写保护问题
- 批量自动递增设备编号
- 自动生成并配对密钥文件

## 🔌 硬件连接

### J-Link 接线表

| J-Link 引脚 | 目标板 (nRF52) | 备注 |
| :--- | :--- | :--- |
| **VTref** (Ping 1) | **VCC / VDD** | **必须连接**，用于检测电压 |
| **GND** (Pin 4/6/8...) | **GND** | 必须共地 |
| **SWDIO** (Pin 7) | **SWDIO** | 数据线 |
| **SWCLK** (Pin 9) | **SWCLK** | 时钟线 |

> ⚠️ **重要提示**:
>
> 1. 大多数 J-Link **不提供对外供电**。
> 2. **必须给目标板外接电源** (电池或 USB 供电)，J-Link 的 VTref 脚才能检测到电压。
> 3. 如果脚本一直提示 "无法读取芯片寄存器"，请首先检查目标板是否有电。

## 🚀 使用步骤

### 1. 运行脚本

在终端中进入项目根目录，运行对应芯片的脚本：

**nRF52832:**

```bash
./n52832autoflash_jlink.sh
```

**nRF52810:**

```bash
./n52810autoflash_jlink.sh
```

### 2. 交互配置

脚本启动后会询问几个关键选项：

1. **设备前缀**: 输入任意 2-5 字母 (如 `TAG`, `BFX`)。
2. **起始编号**: 输入数字 (如 `1`)。
3. **刷写 SoftDevice?**:
    - **首次刷写必须选 `y`** (刷入协议栈)。
    - 后续如果不慎擦除了芯片，也需要选 `y`。
    - 仅更新 App 代码时可选 `n` 以节省时间。
4. **启用 DCDC?**:
    - 如果有外接 DCDC 电感，选 `y` (省电)。
    - 如果是极简版电路 (只有电容)，**必须选 `n`**，否则芯片会无法工作。

### 3. 自动刷写

配置完成后，脚本会自动循环执行：

1. 检测 J-Link 连接。
2. (如果需要) 尝试解锁/擦除芯片。
    - 如果 `nrfjprog recover` 失败，脚本会自动尝试 **Manual Unlock** (直接写寄存器解锁)。
3. 编译最新代码。
4. 烧录 SoftDevice 和 Application。
5. 提示更换下一个设备。

## ❓ 常见问题

### Q: 提示 "Failed to power up DAP" 或无法读取寄存器

- **检查供电**: 目标板必须有电。
- **检查接线**: SWDIO/SWCLK 线不要太长，尽量短。
- **检查速度**: 脚本默认使用 1000kHz，如果环境恶劣，可尝试修改脚本进一步降低速度。

### Q: 刷写后搜不到蓝牙信号

1. **SoftDevice 没刷**: 首次刷写时一定要选 `y` 刷 SoftDevice。
2. **晶振问题**: 代码默认配置可能使用了外部 32.768kHz 晶振。如果板子没有这个晶振，需要修改 `sdk_config.h` 使用内部 RC 振荡器。
3. **DCDC 设置错误**: 不带电感的板子开启了 DCDC 会导致反复复位。重新刷写并禁用 DCDC。

### Q: 脚本卡在 "Recovering..."

- 手动解锁过程可能需要几秒钟。
- 如果一直失败，尝试断开目标板电源，按住 Reset (如果有) 再上电，或者拔插 J-Link USB。
