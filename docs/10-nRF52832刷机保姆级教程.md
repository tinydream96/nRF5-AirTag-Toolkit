# nRF52832 刷机保姆级教程 (小白必看)

欢迎来到 nRF52832 开发世界！本文档专门为没有任何基础的“小白”准备。
我们将一步步教你如何把一个空白的 nRF52832 模块变成一个功能完备的 "AirTag"。

## 🛠 准备工作

在开始之前，请确保你手头有：

1. **nRF52832 开发板/模块** (确保已焊接好引脚)
2. **J-Link 调试器** (V8, V9, OB 均可)
3. **4根杜邦线** (连接模块和调试器)
4. **Mac 电脑** (本教程基于 macOS)

> 💡 **提示**: 本教程假设你已经完成了 [01-环境安装指南](01-环境安装指南.md)。如果没有，请先回去把环境装好。

---

## 第一步：连接硬件 🔌

这是最关键的一步，90% 的失败都是因为线没接好。

请拿出你的 J-Link 和 nRF52832 模块，按下面表格连线：

| J-Link 引脚 | nRF52832 模块 | 作用 |
| :--- | :--- | :--- |
| **VTref (Pin 1)** | **VCC / VDD** | **一定要接！** J-Link 用它检测电压 |
| **GND** | **GND** | 必须共地，否则无法通信 |
| **SWDIO** | **SWDIO** | 数据传输线 |
| **SWCLK** | **SWCLK** | 时钟信号线 |

> ⚠️ **非常重要**: J-Link 通常不给芯片供电！你必须**给 nRF52832 模块单独供电** (插 USB 或接电池)。

---

## 第二步：生成专属密钥 🔑

每个 AirTag 都需要一组独一无二的“身份证” (密钥)，这样苹果网络才能识别它。

1. 打开终端 (Terminal)。
2. 进入项目目录 (假设你在 `nRF5-AirTag-Toolkit` 目录下)。
3. 运行密钥生成工具：

```bash
./scripts/generate_device_keys.sh
```

1. 按提示操作：
    * **设备名称**: 给你的设备起个名字，比如 `MYTAG1` (必须是大写字母+数字，6位)。
    * **密钥数量**: 直接按回车，默认 200 个就够用很久了。

🎉 **成功后**，你会看到类似这样的提示：
> "设备 MYTAG1 的密钥生成完成!"

---

## 第三步：一键刷机 🚀

现在硬件连好了，密钥也有了，我们开始刷入固件。

1. 在终端里运行 nRF52832 专用刷机脚本：

```bash
./n52832autoflash_jlink.sh
```

1. 脚本会问你几个简单的问题：

    * **请输入设备名称前缀**: 输入刚才的前缀，比如 `MYTAG`。
    * **请输入起始设备编号**: 输入 `1`。
    * **是否需要刷写 SoftDevice?**:
        * 👉 **第一次刷机必须选 y** (输入 y 并回车)。
        * (SoftDevice 是协议栈，没有它 App 跑不起来)。
    * **是否启用 DCDC?**:
        * 👉 **强烈建议选 n** (输入 n 并回车)。
        * (除非你确定板子上有 DCDC 电感，否则选 y 会导致不断重启)。

2. **等待刷写完成**

    脚本会自动检测 J-Link，编译代码，解锁芯片，并烧录。

    运行时的界面如下所示（如果遇到芯片被锁，脚本会自动解锁，不用慌）：
    ![脚本运行界面](assets/tutorial_script_run.png)

    如果你看到类似下面的弹窗或进度条，说明正在疯狂写入中：
    ![J-Link 写入进度](assets/tutorial_jlink_progress.png)

    最后看到大大的 🎉 标志，说明刷写成功：
    ![刷写成功界面](assets/tutorial_script_success.png)

    > 🎉🎉🎉 设备 MYTAG1 (nRF52832) 操作成功完成！

    恭喜你！你的专属 AirTag 诞生了！🎈

---

## ❓ 常见报错怎么办？

**Q1: 提示 "Failed to power up DAP" 或 "无法读取芯片寄存器"**

* **原因**: 芯片没电，或者线没接好。
* **解决**:
    1. 检查 nRF52832 是否接了电池/USB 供电。
    2. 拔掉 J-Link USB 再插一次。
    3. 检查杜邦线是不是松了。

**Q2: 提示 "Recover failed"**

* **原因**: 芯片有写保护锁。
* **解决**: 不用担心，上面的脚本会自动尝试“强行解锁”。如果脚本提示 "Manual Unlock 执行完毕"，通常就没问题了。

**Q3: 手机搜不到信号**

* **原因**: 可能是 DCDC 选错了，或者晶振配置不对。
* **解决**:
    1. 重新运行脚本，DCDC 选 `n` 再刷一次。
    2. 确保刚才选了 `y` 刷入 SoftDevice。

---

祝你玩得开心！🚀
