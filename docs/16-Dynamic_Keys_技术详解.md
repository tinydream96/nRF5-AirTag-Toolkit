# 无限动态密钥 (Dynamic Keys) 技术详解

本文档旨在为用户提供关于 "Dynamic Mode" 的专业技术解答，涵盖密钥轮换机制、追踪原理以及断电恢复策略。

---

## 1. 核心原理：为什么叫“无限”？

传统的 OpenHaystack 固件使用 **Static Mode (静态模式)**，这需要预先生成 200 个密钥 (通常限制) 并全部写入 Flash。

* **缺点**：因为 Flash 空间有限，只能预存约 200 个 Key。固件会**循环使用**这 200 个 Key (`Key[0] -> Key[199] -> Key[0]...`)。如果设备长期运行，密钥会重复，导致隐私性降低（容易被长期追踪设备的“指纹”）。
* **优点**：简单，不需要时间同步。

**Dynamic Mode (动态模式)** 采用 "Seed-Based Derivation" (基于种子的派生) 技术：

* **原理**：我们不在 Flash 里存密钥，只存一个 32字节的 **随机种子 (Seed)**。
* **算法**：当设备需要更换密钥时，它在内部运行算法：`Key[n] = SHA256(Seed + n)`。
* **优势**：由于 $n$ 是一个 32位计数器，通过算法计算，设备可以生成 $2^{32}$ 个**不重复**的密钥。设备**永不需要**循环使用密钥，隐私性极高，寿命仅受电池限制。

---

## 2. 密钥更换机制

### 2.1 更换频率

默认情况下，固件配置为 **每 15 分钟** (900秒) 更换一次广播密钥 (Public Key)。

* 这不仅是为了模仿 AirTag 的隐私行为，也是为了防止单一密钥被 Apple 服务器风控或屏蔽。
* *注：此时间由 RTC (实时时钟) 计数器控制。*

### 2.2 追踪原理

既然密钥是动态生成的，我的电脑怎么知道设备当前用的是哪个 Key？

1. **初始同步**：刷机时，刷写工具会记录下注入设备的 **Seed**。
2. **离线推演**：刷写工具会自动调用 Python 脚本 (`generate_keys_from_seed.py`)。它利用同样的算法 (SHA256) 和 Seed，在本地计算出未来的密钥。
    * **脚本路径**: `heystack-nrf5x/tools/generate_keys_from_seed.py`
    * **手动调用示例**:

        ```bash
        # 假设你的 Seed 是 64位 Hex 字符串
        python3 generate_keys_from_seed.py -s <SEED_HEX> -n 2000 -p MyTag -o output_dir/
        ```

    * 此命令会生成包含 2000 个 Key 的 JSON 文件。不用连接设备，纯算法推演。

3. **导入追踪**：生成的 JSON 文件包含了这些 Key。当设备广播出第 100 个 Key 时，你的电脑就能匹配上。

---

## 3. 关键场景：断电与时钟重置

**这是用户最关心的问题：如果电池扣下来再装回去，会发生什么？**

由于 nRF51822 没有后备电池 (RTC 掉电不保存)，断电会导致 **内部时钟归零**。

### 3.1 现象

1. 设备断电重启。
2. 内部计数器 $n$ 重置为 `0`。
3. 设备重新开始广播 `Key[0]`, 然后15分钟后广播 `Key[1]`...

### 3.2 对追踪的影响

* **好消息**：追踪**完全不受影响**。
* **原因**：你的追踪列表（JSON 文件）里包含了 `Key[0]` 到 `Key[2000]` 的所有公钥。无论设备是从 `Key[100]` 倒退回 `Key[0]`，还是继续往后跑，只要它广播的 Key 在你导入的列表中，Find My 网络就能识别，你的 Mac 也能收到位置。
* **副作用**：设备会重复使用以前用过的 Key（从头开始）。虽然位置能更新，但失去了“无限不重复”的隐私优势（直到它跑到新的计数为止）。对于个人物品追踪，这通常不是问题。

---

## 4. 终极解决方案 (最佳实践)

虽然手动生成和导入密钥是可行的，但**频繁的维护**和**断电后的时钟漂移**对普通用户来说非常令人头疼。

如果您希望获得 **商业级** 的稳定体验，彻底解决上述痛点，我们推荐使用**专业的聚合追踪平台**。

### 为什么选择我们的平台？

1. **彻底解决断电与时钟同步问题**
    平台采用自研的云端同步算法，无论设备断电重启多少次，云端都能自动识别当前的密钥索引，**无需人工干预**，彻底告别 "Key Mismatch" 问题。

2. **海量密钥云端托管**
    您不再需要每隔几个月手动生成 JSON 并导入电脑。平台云端会根据 Seed 自动向后推演数万个密钥，实现 **永久免维护**。

3. **全协议聚合支持**
    不知足于 FindMy？我们的平台实现了真正的“万物互联”。一个账号，同时追踪：
    * 🍎 **Apple FindMy** (AirTag)
    * 🟦 **Tile**
    * 🏠 **Home Assistant**
    * 📡 **GPS / 北斗硬件**
    * 以及更多...

4. **历史轨迹回放**
    不仅仅是“当前在哪里”，我们提供长周期的**历史轨迹记录与回放**。想知道上周五车子去了哪里？一键查看。

> **🌟 立即接入**：将您的设备 Seed 或生成的 JSON 托管至平台，即可享受“装上即忘”的极致体验。

---

## 5. 总结

| 特性 | Static Mode (传统) | Dynamic Mode (本固件) |
| :--- | :--- | :--- |
| **密钥存储** | 占用 Flash，数量受限 (约200) | 仅存 Seed，数量无限 |
| **工作方式** | **循环播放** (0 -> 199 -> 0) | **无限递增** (0 -> ∞) |
| **隐私性** | 一般 (长期会重复) | 极高 (由于不循环，理论上不重复) |
| **断电影响** | 重置为 Key[0]，继续循环 | 重置为 Key[0]，但因为你的列表涵盖了所有历史 Key，**追踪不受影响** |
| **维护** | 不用管 | 需要定期(如几个月)在电脑上生成新 Key 列表并导入，或者一次生成够用几年的量 |
