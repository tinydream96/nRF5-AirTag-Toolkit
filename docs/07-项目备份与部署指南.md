# nRF52810-AirTag-Toolkit 项目备份与部署指南

## 📋 概述
本文档详细说明如何备份、部署和使用 nRF52810-AirTag-Toolkit 项目包，确保项目可以在任何 macOS 环境中快速重建。

## 📦 项目包信息

### 🏷️ 项目命名
- **项目名称**: nRF52810-AirTag-Toolkit
- **版本**: v1.0
- **适用系统**: macOS (支持 Intel 和 Apple Silicon)
- **目标芯片**: nRF52810

### 📊 备份包特性
- **完全自包含**: 包含所有必需文件和文档
- **即插即用**: 解压后即可使用
- **跨环境部署**: 可在任何 macOS 系统使用
- **安全可靠**: 包含密钥和预编译固件

## 📁 目录结构详解

```
nRF52810-AirTag-Toolkit/
├── 📚 docs/                    # 完整文档系统
│   ├── 01-环境安装指南.md        # 开发环境搭建
│   ├── 02-项目配置手册.md        # 项目和SDK配置
│   ├── 03-固件编译指南.md        # 编译原理和流程
│   ├── 04-硬件连接与刷写.md      # 硬件连接和刷写
│   ├── 05-快速参考手册.md        # 常用命令速查
│   ├── 06-技术原理解析.md        # 深度技术分析
│   ├── 07-项目备份与部署指南.md  # 本文档
│   └── README-文档导航.md        # 文档使用指南
├── 🔧 scripts/                 # 自动化脚本
│   ├── setup_nrf52810.sh       # 环境检查脚本
│   ├── compile_and_flash_2s.sh # 编译刷写脚本
│   ├── one_click_install.sh    # 一键安装脚本
│   ├── one_click_flash.sh      # 一键刷写脚本
│   └── project_backup.sh       # 项目备份脚本
├── 💾 firmware/                # 预编译固件
│   └── _build/
│       ├── nrf52810_xxaa_s112_patched.bin  # 最终固件(含密钥)
│       ├── nrf52810_xxaa_s112.hex          # 完整固件
│       └── nrf52810_xxaa.hex               # 应用程序
├── ⚙️ config/                  # 配置文件
│   ├── R0VVSW_keyfile          # 密钥文件
│   └── openocd.cfg             # OpenOCD配置
├── 📦 heystack-nrf5x/          # 项目源码
│   ├── nrf52810/               # nRF52810特定代码
│   ├── main.c                  # 主程序
│   ├── ble_stack.c             # 蓝牙栈
│   └── Makefile*               # 构建配置
├── 🛠️ tools/                   # 工具说明
│   └── TOOLS_REQUIRED.md       # 必需工具清单
├── 📋 PROJECT_INFO.md          # 项目信息
└── 📖 USAGE.md                 # 快速使用指南
```

## 🚀 部署流程

### 方法1: 全新环境部署 (推荐)

#### 步骤1: 解压项目包
```bash
# 解压备份包
tar -xzf nRF52810-AirTag-Toolkit-backup-*.tar.gz

# 进入项目目录
cd nRF52810-AirTag-Toolkit-backup-*
```

#### 步骤2: 一键安装环境
```bash
# 运行一键安装脚本
./scripts/one_click_install.sh
```

#### 步骤3: 验证安装
```bash
# 检查环境是否完整
./scripts/setup_nrf52810.sh
```

#### 步骤4: 连接硬件并刷写
```bash
# 连接ST-Link V2和nRF52810后执行
./scripts/one_click_flash.sh
```

### 方法2: 手动部署

#### 步骤1: 环境准备
```bash
# 安装Homebrew (如果未安装)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装开发工具
brew install --cask gcc-arm-embedded
brew install openocd libusb git python3
brew install --cask nordic-nrf-command-line-tools
pip3 install intelhex
```

#### 步骤2: 下载nRF5 SDK
```bash
# 创建SDK目录
mkdir -p nrf-sdk

# 下载并解压nRF5 SDK 15.3.0到nrf-sdk/目录
# 下载地址: https://www.nordicsemi.com/Software-and-tools/Software/nRF5-SDK
```

#### 步骤3: 配置项目
```bash
# 检查环境
./scripts/setup_nrf52810.sh

# 如果需要重新编译
cd heystack-nrf5x/nrf52810/armgcc
make clean
make patched_nrf52810_xxaa [参数...]
```

## 🔧 自动化脚本说明

### 1. one_click_install.sh
- **功能**: 自动安装所有必需的开发工具
- **包含**: Homebrew工具、Python包、环境配置
- **使用**: `./scripts/one_click_install.sh`

### 2. one_click_flash.sh  
- **功能**: 一键刷写预编译固件到芯片
- **前提**: 硬件已正确连接
- **使用**: `./scripts/one_click_flash.sh`

### 3. setup_nrf52810.sh
- **功能**: 检查开发环境完整性
- **输出**: 详细的环境状态报告
- **使用**: `./scripts/setup_nrf52810.sh`

### 4. compile_and_flash_2s.sh
- **功能**: 编译并刷写固件(2秒广播间隔)
- **适用**: 需要重新编译时使用
- **使用**: `./scripts/compile_and_flash_2s.sh`

## 📋 固件配置说明

### 预编译固件参数
```
HAS_DCDC=0                    # 使用LDO稳压器
HAS_BATTERY=1                 # 启用电量报告
KEY_ROTATION_INTERVAL=300     # 密钥轮换间隔5分钟
MAX_KEYS=200                  # 最大密钥数量200
ADVERTISING_INTERVAL=2000     # 蓝牙广播间隔2秒
```

### 固件文件说明
- `nrf52810_xxaa_s112_patched.bin`: 最终固件(含密钥和SoftDevice)
- `nrf52810_xxaa_s112.hex`: 完整固件(HEX格式)
- `nrf52810_xxaa.hex`: 仅应用程序

## 🔍 验证和测试

### 环境验证清单
- [ ] ARM GCC工具链已安装
- [ ] OpenOCD调试工具可用
- [ ] Nordic命令行工具可用
- [ ] Python intelhex包已安装
- [ ] nRF5 SDK已下载配置
- [ ] 密钥文件存在且可读
- [ ] ST-Link硬件连接正常

### 功能测试
```bash
# 1. 编译测试
cd heystack-nrf5x/nrf52810/armgcc
make clean && make nrf52810_xxaa

# 2. 硬件连接测试
openocd -f config/openocd.cfg -c "init; targets; exit"

# 3. 固件刷写测试
./scripts/one_click_flash.sh
```

## 🛡️ 安全注意事项

### 密钥管理
- **保密性**: 密钥文件包含敏感信息，请妥善保管
- **备份**: 建议对密钥文件单独备份
- **访问控制**: 限制项目包的访问权限

### 固件安全
- **验证**: 刷写前验证固件完整性
- **版本控制**: 记录固件版本和配置参数
- **测试**: 在测试设备上验证功能

## 🔄 更新和维护

### 项目更新
```bash
# 1. 备份当前配置
cp config/R0VVSW_keyfile ~/backup/

# 2. 更新源码
git pull origin main

# 3. 重新编译
make clean && make patched_nrf52810_xxaa [参数...]

# 4. 重新打包
./scripts/project_backup.sh
```

### 文档维护
- 定期更新文档内容
- 记录新发现的问题和解决方案
- 更新工具版本信息

## 🚨 故障排除

### 常见部署问题

#### 1. 权限问题
```bash
# 解决方案
sudo chown -R $(whoami) /opt/homebrew
chmod +x scripts/*.sh
```

#### 2. 网络问题
```bash
# 使用镜像源
export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles
```

#### 3. 工具版本冲突
```bash
# 清理并重新安装
brew uninstall --cask gcc-arm-embedded
brew install --cask gcc-arm-embedded
```

### 获取帮助
1. 查看对应的详细文档
2. 运行环境检查脚本
3. 检查工具版本兼容性
4. 参考GitHub项目页面

## 📈 最佳实践

### 部署建议
1. **使用一键安装**: 减少手动配置错误
2. **验证每个步骤**: 确保环境正确配置
3. **保留备份**: 定期创建项目备份
4. **文档先行**: 部署前仔细阅读相关文档

### 开发建议
1. **版本控制**: 使用Git管理代码变更
2. **测试驱动**: 每次修改后进行完整测试
3. **参数记录**: 记录每次编译的参数配置
4. **安全第一**: 保护密钥和敏感信息

---
*最后更新: 2024年7月20日*