# nRF52810 芯片保护恢复指南

## 📋 概述
当 nRF52xxx 芯片的访问端口(AP)被禁用或芯片处于保护状态时，需要特殊的恢复流程。本文档详细说明如何使用项目提供的脚本和工具来恢复被保护的芯片。

## 🚨 什么是芯片保护

### 保护状态的表现
- OpenOCD 连接失败: `unable to connect to the target`
- 编程失败: `Programming failed`
- 访问被拒绝: `Access port disabled`
- nrfjprog 读取失败

### 保护产生的原因
1. **意外的固件配置** - 固件禁用了调试接口
2. **错误的寄存器设置** - UICR 寄存器配置错误
3. **安全功能启用** - 芯片的安全保护被激活
4. **固件崩溃** - 固件运行异常导致调试接口不可用

## 🛠️ 恢复工具和方法

### 方法优先级
1. **nrfjprog --recover** (推荐) ⭐️
2. **OpenOCD mass_erase** (备选)
3. **手动配置切换** (高级)

### 工具要求
- **nrfjprog**: Nordic 官方工具 (推荐 J-Link)
- **OpenOCD**: 开源调试工具
- **J-Link**: 推荐调试器 (对保护恢复支持最好)
- **ST-Link**: 备选调试器 (部分功能受限)

## 🚀 一键恢复脚本

### 快速恢复 (推荐)
```bash
# 自动检测并恢复 nRF52 芯片
./scripts/quick_chip_recovery.sh

# 恢复 nRF51 芯片
./scripts/quick_chip_recovery.sh nrf51
```

### 完整恢复脚本
```bash
# 自动检测恢复
./scripts/recover_protected_chip.sh

# 指定芯片类型
./scripts/recover_protected_chip.sh -t nrf52810

# 指定调试器类型
./scripts/recover_protected_chip.sh -d jlink

# 使用自定义配置
./scripts/recover_protected_chip.sh -c custom_openocd.cfg

# 查看帮助
./scripts/recover_protected_chip.sh -h
```

## 🔧 手动恢复方法

### 方法1: nrfjprog 恢复 (最推荐)

#### 前提条件
```bash
# 安装 Nordic Command Line Tools
brew install --cask nordic-nrf-command-line-tools

# 验证安装
nrfjprog --version
```

#### 恢复命令
```bash
# nRF52 系列 (nRF52810, nRF52832)
nrfjprog --recover -f nrf52

# nRF51 系列
nrfjprog --recover -f nrf51

# 验证恢复
nrfjprog --readcode -f nrf52
```

#### 成功标志
```
Recovering device. This operation might take 30s.
Writing debug port register...
Erasing user code and UICR flash areas.
Applying pin reset.
Checking that the area to write is not protected.
Programming device.
```

### 方法2: OpenOCD mass_erase

#### 配置文件准备
```bash
# 检查现有配置
ls heystack-nrf5x/nrf52810/armgcc/openocd.cfg

# 或创建临时配置
cat > recovery_openocd.cfg << EOF
# ST-Link 配置
source [find interface/stlink.cfg]
source [find target/nrf52.cfg]
transport select hla_swd
adapter speed 1000
init
EOF
```

#### 执行恢复
```bash
# nRF52 系列
openocd -f recovery_openocd.cfg -c "init; halt; nrf5 mass_erase; reset; exit"

# nRF51 系列
openocd -f recovery_openocd.cfg -c "init; halt; nrf51 mass_erase; reset; exit"
```

#### 成功输出示例
```
Info : STLINK V2J46S7 (API v2) VID:PID 0483:3748
Info : Target voltage: 3.168992
Info : nrf52.cpu: hardware has 6 breakpoints, 4 watchpoints
target halted due to debug-request, current mode: Thread 
Info : Mass erase completed.
```

### 方法3: 调试器切换

#### ST-Link 转 J-Link
```bash
# 修改配置文件
sed -i '' 's/interface\/stlink.cfg/interface\/jlink.cfg/' openocd.cfg
sed -i '' 's/hla_swd/swd/' openocd.cfg

# 重新尝试恢复
openocd -f openocd.cfg -c "init; halt; nrf5 mass_erase; reset; exit"
```

#### J-Link 转 ST-Link
```bash
# 修改配置文件
sed -i '' 's/interface\/jlink.cfg/interface\/stlink.cfg/' openocd.cfg
sed -i '' 's/transport select swd/transport select hla_swd/' openocd.cfg

# 重新尝试恢复
openocd -f openocd.cfg -c "init; halt; nrf5 mass_erase; reset; exit"
```

## 🔍 故障排除

### 常见错误和解决方案

#### 错误1: nrfjprog 未找到
```
nrfjprog: command not found
```
**解决方案:**
```bash
brew install --cask nordic-nrf-command-line-tools
```

#### 错误2: 调试器未检测
```
ERROR: JLink not found
ERROR: No ST-Link detected
```
**解决方案:**
1. 检查 USB 连接
2. 检查调试器驱动
3. 尝试不同的 USB 端口

#### 错误3: 目标电压异常
```
Target voltage: 0.000000
```
**解决方案:**
1. 检查 3.3V 电源连接
2. 检查 GND 连接
3. 测量实际电压

#### 错误4: 恢复超时
```
Timeout while recovering device
```
**解决方案:**
1. 降低调试器速度
2. 检查硬件连接稳定性
3. 尝试多次恢复

### 高级故障排除

#### 使用 J-Link Commander
```bash
# 启动 J-Link Commander
JLinkExe

# 在 J-Link 命令行中执行
J-Link> connect
J-Link> device nrf52810
J-Link> si swd
J-Link> speed 1000
J-Link> unlock kinetis
J-Link> erase
J-Link> exit
```

#### 检查芯片状态
```bash
# 读取芯片信息
nrfjprog --ids -f nrf52

# 读取 UICR 寄存器
nrfjprog --memrd 0x10001000 --n 32 -f nrf52

# 检查保护状态
nrfjprog --readregs -f nrf52
```

## 📊 恢复成功验证

### 验证步骤
1. **连接测试**
   ```bash
   openocd -f openocd.cfg -c "init; targets; exit"
   ```

2. **读取测试**
   ```bash
   nrfjprog --readcode -f nrf52
   ```

3. **编程测试**
   ```bash
   # 编译并刷写固件
   cd heystack-nrf5x/nrf52810/armgcc
   make stflash-nrf52810_xxaa-patched [参数...]
   ```

### 成功标志
- ✅ OpenOCD 能正常连接目标
- ✅ nrfjprog 能读取芯片代码
- ✅ 固件能正常编程和验证
- ✅ 设备能正常启动和工作

## 🔄 恢复后的后续步骤

### 1. 重新刷写固件
```bash
# 使用便捷脚本
./scripts/compile_and_flash_2s.sh

# 或手动编译刷写
cd heystack-nrf5x/nrf52810/armgcc
make stflash-nrf52810_xxaa-patched \
    HAS_DCDC=0 \
    HAS_BATTERY=1 \
    KEY_ROTATION_INTERVAL=300 \
    MAX_KEYS=200 \
    ADVERTISING_INTERVAL=2000 \
    ADV_KEYS_FILE=./R0VVSW_keyfile
```

### 2. 验证功能
```bash
# 启用调试模式验证
make stflash-nrf52810_xxaa-patched HAS_DEBUG=1 [其他参数...]

# 监控日志
make rtt-monitor
```

### 3. 预防再次保护
- 避免修改 UICR 寄存器
- 不要禁用调试接口
- 测试固件稳定性
- 保留恢复用的配置文件

## 📝 脚本使用示例

### 基础使用
```bash
# 最简单的使用方式
./scripts/quick_chip_recovery.sh

# 输出示例:
# === nRF52810 芯片保护快速恢复 ===
# ✅ 工具检查完成
# [方法1] 使用 nrfjprog 恢复...
# ✅ nrfjprog 恢复成功！
# ✅ 芯片验证成功，恢复完成！
```

### 高级使用
```bash
# 指定芯片和调试器
./scripts/recover_protected_chip.sh -t nrf52810 -d jlink

# 使用自定义配置
./scripts/recover_protected_chip.sh -c my_openocd.cfg

# 查看详细日志
tail -f chip_recovery_*.log
```

## 🆘 寻求帮助

### 文档参考
1. 本恢复指南 (当前文档)
2. [硬件连接与刷写指南](04-硬件连接与刷写.md)
3. [快速参考手册](05-快速参考手册.md)

### 常用资源
- [Nordic nrfjprog 文档](https://infocenter.nordicsemi.com/index.jsp)
- [OpenOCD 官方文档](http://openocd.org/doc/)
- [J-Link 用户手册](https://www.segger.com/products/debug-probes/j-link/)

### 社区支持
- GitHub Issues
- Nordic DevZone
- OpenOCD 邮件列表

---
*最后更新: 2024年7月*
*创建时间: 2024年7月*